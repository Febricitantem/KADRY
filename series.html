<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Серия | Kadry</title>
  <style>
    :root {
      --bg: #f4f4f5;
      --text: #111827;
      --muted: #64748b;
      --stroke: #e5e7eb;
    }

    /* Общая тема */
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif
    }

    /* Универсальная шапка как на каталоге/голосованиях */
    .site-header {
      position: relative;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: center;
      padding: 10px 18px 14px;
      background: #f8fafc;
      border-bottom: 1px solid var(--stroke);
      min-height: 65px;
    }
    .hslot {
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: inherit;
      font-weight: 600;
    }
    .hslot:hover {
      background: #e5e7eb40;
    }
    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1;
    }
    .brand .above {
      font-size: 30px;
      font-weight: 800;
      transform: translateY(-18%);
    }
    .brand .below {
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .04em;
      text-transform: uppercase;
      transform: translateY(18%);
    }

    .wrap{max-width:1200px;margin:22px auto;padding:0 18px;}
    h1{font-size:36px;font-weight:800;margin:8px 0 18px;text-align:center}

    /* Экран показа кадра */
    .stage{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      padding:12px
    }
    .viewport{
      border:1px solid #e5e7eb;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      aspect-ratio:16/9;
      width:100%;
      max-height:62vh;
      background:#fff
    }
    .viewport img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:block
    }

    /* Навигация по кадрам */
    .controls{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin:12px 0
    }
    .btn{
      padding:6px 10px;
      border:1px solid #d1d5db;
      border-radius:8px;
      background:#fff;
      cursor:pointer
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed
    }
    .pos{
      min-width:64px;
      text-align:center;
      font-weight:700
    }

    /* Низ страницы */
    .bottom{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:8px
    }
    .primary{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb
    }
    .danger{
      background:#ef4444;
      color:#fff;
      border-color:#ef4444
    }
    .danger:hover{
      filter:brightness(.95)
    }

    /* Описание и комментарии */
    .desc-box{
      margin:18px 0 8px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      padding:14px
    }
    .desc-box h2{
      margin:0 0 8px;
      font-size:18px;
      font-weight:800
    }
    .desc-text{
      color:#334155;
      white-space:pre-wrap
    }

    .comments{
      margin:12px 0 30px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .comments header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 14px;
      background:#f8fafc;
      border-bottom:1px solid #e5e7eb;
      color:#111827
    }
    .comments h3{
      margin:0;
      font-size:18px;
      font-weight:800
    }
    .comment-list{
      padding:10px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:380px;
      overflow-y:auto;
      scrollbar-gutter:stable;
    }
    .comment{
      position:relative;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:8px 10px
    }
    .comment .del-btn{
      position:absolute;
      top:6px;
      right:6px;
      border:none;
      background:transparent;
      border-radius:8px;
      width:20px;
      height:20px;
      cursor:pointer;
      line-height:20px;
      text-align:center;
      color:#94a3b8
    }
    .comment .del-btn:hover{
      color:#475569;
      transform:scale(1.05)
    }
    .comment .meta{
      font-size:12px;
      color:#64748b;
      margin-bottom:6px
    }
    .comment .body{
      white-space:pre-wrap
    }
    .comment-form{
      padding:10px 14px;
      border-top:1px solid #e5e7eb;
      display:grid;
      grid-template-columns:1fr 140px;
      gap:10px
    }
    .comment-form input,
    .comment-form textarea{
      font:inherit;
      border:1px solid #d1d5db;
      border-radius:10px;
      padding:8px 10px
    }
    .comment-form textarea{
      min-height:60px;
      resize:vertical
    }
    .comment-form .btn{
      height:40px
    }

    /* Админ-видимость */
    .admin-only{display:none}
    .is-admin .admin-only{display:block}
  
    body.site-closed {
      overflow: hidden;
    }
    .site-closed-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(6px);
    }
    .site-closed-card {
      max-width: 420px;
      width: 100%;
      border-radius: 16px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 18px 18px 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.8);
      font-size: 14px;
    }
    .site-closed-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .site-closed-text {
      font-size: 14px;
      color: #cbd5f5;
    }
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="admin.js"></script>
</head>
<body>

  <div id="site-closed-overlay" class="site-closed-overlay" style="display:none">
    <div class="site-closed-card">
      <div class="site-closed-title">Онлайн сейчас закрыт</div>
      <div class="site-closed-text" id="site-closed-message">
        Рисование временно недоступно. Попробуйте зайти позже.
      </div>
    </div>
  </div>

  <header class="site-header">
    <div class="hslot h1">
      <div class="brand">
        <div class="above">Серия</div>
        <div class="below">Kadry</div>
      </div>
    </div>
    <a class="hslot h2" href="index.html">Каталог</a>
    <a class="hslot h3" href="votes.html">Голосования</a>
    <a class="hslot h4" href="#">Профиль</a>
  </header>

  <div class="wrap">
    <h1 id="series-title">Серия</h1>

    <div class="stage">
      <div class="viewport">
        <img id="frame-img" alt="Кадр" loading="lazy" />
      </div>
    </div>

    <div class="controls">
      <button id="first-btn" class="btn" title="В начало">⟨⟨</button>
      <button id="prev-btn"  class="btn" title="Назад">⟨</button>
      <div id="pos-label" class="pos">— / —</div>
      <button id="next-btn"  class="btn" title="Вперёд">⟩</button>
      <button id="last-btn"  class="btn" title="В конец">⟩⟩</button>
    </div>

    <div class="bottom">
      <button id="draw-btn" class="btn primary">Рисовать</button>
      <button id="go-to-vote" class="btn">Голосование серии</button>
    </div>

    <!-- Описание серии -->
    <section class="desc-box">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <h2 style="margin:0">Описание серии</h2>
        <button id="desc-edit-btn" class="btn admin-only" title="Редактировать описание">✎</button>
      </div>
      <div id="series-desc" class="desc-text" style="margin-top:8px">Описание отсутствует.</div>
      <form id="desc-form" style="display:none; margin-top:10px;" onsubmit="return false;">
        <textarea id="desc-input" class="desc-text" style="width:100%; box-sizing:border-box; border:1px solid #d1d5db; border-radius:10px; padding:10px; min-height:100px; resize:vertical" placeholder="Напишите описание серии…"></textarea>
        <div class="bottom" style="justify-content:flex-end; gap:8px; margin-top:8px">
          <button id="desc-cancel" class="btn" type="button">Отмена</button>
          <button id="desc-save" class="btn primary" type="button">Сохранить</button>
        </div>
      </form>
    </section>

    <!-- Комментарии -->
    <section class="comments" id="comments">
      <header>
        <h3>Комментарии</h3>
      </header>
      <div id="comment-list" class="comment-list"></div>
      <form id="comment-form" class="comment-form">
        <div style="display:flex;flex-direction:column;gap:8px">
          <input id="c-name" type="text" placeholder="Ваше имя (необязательно)" />
          <textarea id="c-text" placeholder="Напишите что-нибудь…"></textarea>
        </div>
        <button class="btn primary" type="submit">Опубликовать</button>
      </form>
    </section>

    <!-- Админ-панель: удаление серии -->
    <div class="bottom admin-only" id="admin-bar" style="justify-content:flex-end">
      <button id="delete-series" class="btn danger">Удалить серию</button>
    </div>
  </div>

<script>
(function(){
  'use strict';
  var supabase = (function(){
    var g = window;
    if (g.__supabaseClient) return g.__supabaseClient;
    var client = g.supabase.createClient(
      'https://upanhirmxhfzpajvswoq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwYW5oaXJteGhmenBhanZzd29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjIwNzcsImV4cCI6MjA3MjIzODA3N30.HhrccU3DfoLadflBmTxIDXJgrDQB3m2zLRX3vtRycGA',
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          storageKey: 'kadry-auth'
        }
      }
    );
    g.__supabaseClient = client;
    return client;
  })();

  var _rawId = new URLSearchParams(location.search).get('id');
  var seriesId = Number(_rawId);
  if(!isFinite(seriesId) || seriesId<=0){
    console.warn('series.html: неверный id в URL', _rawId);
    location.replace('index.html');
    return;
  }

  var committedFrames = [];
  var current = 0;

  var titleEl = document.getElementById('series-title');
  var descEl  = document.getElementById('series-desc');
  var descForm = document.getElementById('desc-form');
  var descInput= document.getElementById('desc-input');
  var descEdit = document.getElementById('desc-edit-btn');
  var descSave = document.getElementById('desc-save');
  var descCancel = document.getElementById('desc-cancel');
  var imgEl   = document.getElementById('frame-img');
  var posEl   = document.getElementById('pos-label');
  var firstBtn= document.getElementById('first-btn');
  var prevBtn = document.getElementById('prev-btn');
  var nextBtn = document.getElementById('next-btn');
  var lastBtn = document.getElementById('last-btn');

  var listEl  = document.getElementById('comment-list');
  var formEl  = document.getElementById('comment-form');
  var nameEl  = document.getElementById('c-name');
  var textEl  = document.getElementById('c-text');

  var isAdmin = document.documentElement.classList.contains('is-admin');
  window.addEventListener('admin:enabled', function(){ isAdmin = true;  syncAdminUI(); });
  window.addEventListener('admin:disabled',function(){ isAdmin = false; syncAdminUI(); });

  function syncAdminUI(){
    // Кнопка редактирования описания доступна только админу.
    if (descEdit) {
      descEdit.style.display = isAdmin ? 'inline-block' : 'none';
    }
    var adminBars = document.querySelectorAll('.admin-only');
    adminBars.forEach(function (el) { el.style.display = isAdmin ? '' : 'none'; });
  }

  // Фразы-заглушки для пустого описания (НЕ сохраняются в БД — только отображаются)
  var descriptionPlaceholders = [
    'Hello, world!',
    'It works!',
    'Не судите строго.',
    'Привет, это моя серия!',
    'Вы кадр №…',
    'Если вы это читаете — значит всё работает.'
  ];
  var activePlaceholder = null;

  var signedCache = new Map();
  function getDisplayUrl(storedUrl){
    return new Promise(function(resolve){
      try{
        if(!storedUrl){ resolve(storedUrl); return; }
        if(/^data:/.test(storedUrl)){ resolve(storedUrl); return; }
        if((storedUrl.indexOf('http://')===0 || storedUrl.indexOf('https://')===0) && storedUrl.indexOf('/storage/v1/object/')===-1){ resolve(storedUrl); return; }
        if(storedUrl.indexOf('/storage/v1/object/public/Frames/')!==-1){ resolve(storedUrl); return; }
        if(storedUrl.indexOf('token=')!==-1){ resolve(storedUrl); return; }
        if(signedCache.has(storedUrl)){ resolve(signedCache.get(storedUrl)); return; }
        var m = storedUrl.match(/(?:Frames|frames)\/([^?]+)(?:\?|$)/);
        var key = m && m[1] ? m[1] : null;
        if(!key){
          var pure = storedUrl.split('?')[0];
          var tail = pure.split('/').pop();
          if(tail && pure.indexOf('.supabase.')===-1) key = decodeURIComponent(tail);
        }
        if(!key){ resolve(storedUrl); return; }
        var last = key.split('/').pop();
        var candidates = [key,'public/'+key,last,'public/'+last];
        (function tryNext(i){
          if(i>=candidates.length){
            var pub1 = supabase.storage.from('Frames').getPublicUrl(key);
            if(pub1 && pub1.data && pub1.data.publicUrl){ resolve(pub1.data.publicUrl); return; }
            resolve(storedUrl); return;
          }
          supabase.storage.from('Frames').createSignedUrl(candidates[i],3600)
            .then(function(r){
              if(!r.error && r.data && r.data.signedUrl){ signedCache.set(storedUrl,r.data.signedUrl); resolve(r.data.signedUrl); }
              else tryNext(i+1);
            })
            .catch(function(){ tryNext(i+1); });
        })(0);
      }catch(e){ console.warn('getDisplayUrl error',e); resolve(storedUrl); }
    });
  }

  function fmtPos(){ return (current+1)+' / '+committedFrames.length; }

  function renderStage(){
    if(!committedFrames.length){
      imgEl.removeAttribute('src');
      posEl.textContent = 'Кадров пока нет';
      firstBtn.disabled = prevBtn.disabled = true;
      nextBtn.disabled  = lastBtn.disabled  = true;
      return Promise.resolve();
    }
    var frame = committedFrames[current];
    return getDisplayUrl(frame.image_url).then(function(url){
      imgEl.onerror = function(){
        try{
          var tail = (frame.image_url||'').split('?')[0].split('/').pop();
          if(tail){
            var pub = supabase.storage.from('Frames').getPublicUrl(tail);
            if(pub && pub.data && pub.data.publicUrl){ imgEl.src = pub.data.publicUrl; return; }
            var pub2 = supabase.storage.from('Frames').getPublicUrl('public/'+tail);
            if(pub2 && pub2.data && pub2.data.publicUrl){ imgEl.src = pub2.data.publicUrl; return; }
          }
        }catch(_){ }
      };
      imgEl.src = url;
      posEl.textContent = fmtPos();
      firstBtn.disabled = prevBtn.disabled = (current<=0);
      nextBtn.disabled  = lastBtn.disabled  = (current>=committedFrames.length-1);
    });
  }

  function loadSeries(){
    return supabase
      .from('series').select('title, description').eq('id', seriesId).maybeSingle()
      .then(function(r){
        if(r.error){ console.error('series load error', r.error); }
        var s = r.data;
        if(!s){ 
          titleEl.textContent='Серия'; 
          descEl.textContent='Описание отсутствует.'; 
          descInput.value = ''; 
          descInput.defaultValue = ''; 
          return; 
        }
        titleEl.textContent = s.title || 'Серия';
        if (s.description && s.description.trim()) {
          // В БД есть сохранённое описание
          activePlaceholder = null;
          descEl.textContent = s.description;
          descInput.value = s.description;
          descInput.defaultValue = s.description;
        } else {
          // В БД описания нет — показываем только визуальный плейсхолдер,
          // в поле ввода он не попадает.
          activePlaceholder = descriptionPlaceholders[Math.floor(Math.random() * descriptionPlaceholders.length)];
          descEl.textContent = activePlaceholder;
          descInput.value = '';
          descInput.defaultValue = '';
        }
        syncAdminUI();
      })
      .then(function(){
        return supabase
          .from('frames')
          .select('id,image_url,order_index,committed,in_vote')
          .eq('series_id', seriesId)
          .eq('committed', true)
          .order('order_index', { ascending:true, nullsFirst:false })
          .order('id', { ascending:true });
      })
      .then(function(r){
        if(r && r.error){ console.error('frames load error', r.error); }
        committedFrames = (r && r.data) ? r.data : [];
        current = Math.max(0, committedFrames.length - 1);
        return renderStage();
      })
      .then(function(){ loadComments(true); })
      .catch(function(e){ console.error('loadSeries fatal', e); });
  }

  firstBtn.onclick = function(){ if(committedFrames.length){ current=0; renderStage(); } };
  prevBtn.onclick  = function(){ if(current>0){ current--; renderStage(); } };
  nextBtn.onclick  = function(){ if(current<committedFrames.length-1){ current++; renderStage(); } };
  lastBtn.onclick  = function(){ if(committedFrames.length){ current=committedFrames.length-1; renderStage(); } };

  window.addEventListener('keydown', function(e){
    if(e.key==='ArrowLeft')  prevBtn.click();
    if(e.key==='ArrowRight') nextBtn.click();
    if(e.key==='Home')       firstBtn.click();
    if(e.key==='End')        lastBtn.click();
  });

  document.getElementById('draw-btn').onclick = function(){ location.href = 'editor.html?series='+seriesId; };
  document.getElementById('go-to-vote').onclick = function(){ location.href = 'vote.html?series='+seriesId; };

  var PAGE_SIZE = 20;
  var cmOffset = 0;
  var cmTotal = null;
  var cmLoading = false;

  function renderComment(c){
    var wrap=document.createElement('div'); wrap.className='comment';
    var del=document.createElement('button'); del.className='del-btn admin-only'; del.innerHTML='✕'; del.title='Удалить'; del.setAttribute('data-id', c.id);
    var meta=document.createElement('div'); meta.className='meta';
    var who=(c.author_name && c.author_name.trim()) ? c.author_name.trim() : 'Гость';
    var when=new Date(c.created_at).toLocaleString();
    meta.textContent = who+' • '+when;
    var body=document.createElement('div'); body.className='body'; body.textContent=c.content||'';
    wrap.appendChild(del); wrap.appendChild(meta); wrap.appendChild(body);
    if(!isAdmin) del.style.display='none';
    return wrap;
  }

  function loadComments(reset){
    if(reset){ cmOffset = 0; cmTotal = null; listEl.textContent = ''; }
    if(cmLoading) return; cmLoading = true;
    var from = cmOffset;
    var to   = cmOffset + PAGE_SIZE - 1;
    supabase
      .from('comments')
      .select('id, author_name, content, created_at', { count: 'exact' })
      .eq('series_id', seriesId)
      .order('created_at', { ascending: true })
      .range(from, to)
      .then(function(r){
        if(r.error){
          if(reset) listEl.textContent = 'Не удалось загрузить комментарии';
          console.error(r.error);
          cmLoading = false; return;
        }
        if(cmTotal===null && typeof r.count==='number') cmTotal = r.count;
        var arr = r.data || [];
        for(var i=0;i<arr.length;i++) listEl.appendChild(renderComment(arr[i]));
        cmOffset += arr.length;
        cmLoading = false;
        syncAdminUI();
      });
  }

  // Догрузка при прокрутке в конец списка
  listEl.addEventListener('scroll', function(){
    if(cmLoading) return;
    if(cmTotal!==null && cmOffset>=cmTotal) return;
    var nearBottom = listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 24;
    if(nearBottom) loadComments(false);
  });

  // Удаление комментария — только админ (RPC предпочтительно)
  listEl.addEventListener('click', function(e){
    var btn = e.target.closest('.del-btn');
    if(!btn) return;
    if(!isAdmin){ return; }
    var id = Number(btn.getAttribute('data-id'));
    if(!id) return;
    if(!confirm('Удалить этот комментарий?')) return;
    var adminToken = localStorage.getItem('admin_token') || '';
    if(supabase.rpc){
      supabase.rpc('delete_comment', { _comment_id: id, _admin_token: adminToken })
        .then(function(r){
          if(r.error || r.data!==true){ alert('Не удалось удалить комментарий'); return; }
          var card = btn.closest('.comment'); if(card) card.remove();
          if(cmTotal!==null && cmTotal>0) cmTotal -= 1;
        });
    } else {
      // Фолбэк (до появления RPC): прямое удаление — предполагает RLS для админа
      supabase.from('comments').delete().eq('id', id).then(function(r){
        if(r.error){ alert('Не удалось удалить комментарий'); return; }
        var card = btn.closest('.comment'); if(card) card.remove();
        if(cmTotal!==null && cmTotal>0) cmTotal -= 1;
      });
    }
  });

  // Отправка нового комментария — всем доступно
  formEl.addEventListener('submit', function(e){
    e.preventDefault();
    var content = (textEl.value||'').trim(); if(!content){ textEl.focus(); return; }
    var author  = (nameEl.value||'').trim() || null;
    supabase
      .from('comments')
      .insert([{ series_id: seriesId, author_name: author, content: content }])
      .select('*')
      .single()
      .then(function(r){
        if(r.error){ alert('Не удалось сохранить комментарий'); return; }
        listEl.appendChild(renderComment(r.data));
        // Локально обновим смещение/тотал
        cmOffset += 1; if(cmTotal!==null) cmTotal += 1; else cmTotal = cmOffset;
        formEl.reset();
        listEl.scrollTop = listEl.scrollHeight;
        syncAdminUI();
      });
  });

  // Редактирование описания серии
  function toggleDescEdit(on){
    if(on){ descForm.style.display='block'; descEl.style.display='none'; descInput.focus(); }
    else  { descForm.style.display='none';  descEl.style.display='block'; }
  }
  if(descEdit)   descEdit.addEventListener('click', function(){ toggleDescEdit(true); });
  if(descCancel) descCancel.addEventListener('click', function(){
    // Вернуть значение к последнему сохранённому
    var last = descInput.defaultValue || '';
    descInput.value = last;
    if (last && last.trim()) {
      activePlaceholder = null;
      descEl.textContent = last;
    } else {
      if (!activePlaceholder) {
        activePlaceholder = descriptionPlaceholders[Math.floor(Math.random() * descriptionPlaceholders.length)];
      }
      descEl.textContent = activePlaceholder;
    }
    toggleDescEdit(false);
  });
  if(descSave){
    descSave.addEventListener('click', function(){
      var content = (descInput.value||'').trim();
      // Пустое описание не сохраняем — оставляем плейсхолдер на экране
      if(!content){
        descEl.textContent = activePlaceholder || descriptionPlaceholders[Math.floor(Math.random()*descriptionPlaceholders.length)];
        toggleDescEdit(false);
        return;
      }
      // Описание может менять только админ
      if(!isAdmin){
        alert('Описание может менять только админ');
        return;
      }
      supabase
        .from('series')
        .update({ description: content })
        .eq('id', seriesId)
        .then(function(r){
          if(r.error){ alert('Не удалось сохранить описание'); return; }
          activePlaceholder = null;
          descEl.textContent = content; 
          descInput.defaultValue = content;
          toggleDescEdit(false);
          syncAdminUI();
        });
    });
  }

  // Удаление серии + медиа из бакета — только админ
  function extractStorageKeys(url){
    var keys=[]; if(!url) return keys;
    try{
      var m=url.match(/\/storage\/v1\/object\/(?:public\/)?(Frames\/.+?)(?:\?.*)?$/);
      if(m && m[1]){ var k=m[1].replace(/^Frames\//,''); keys.push(k); keys.push('public/'+k); }
      else { var tail=url.split('?')[0].split('/').pop(); if(tail){ keys.push(tail); keys.push('public/'+tail); } }
    }catch(_){ }
    return Array.from(new Set(keys));
  }

  document.getElementById('delete-series').addEventListener('click', function(){
    if(!isAdmin) return;
    if(!confirm('Удалить всю серию и связанные изображения? Это действие необратимо.')) return;
    var adminToken = localStorage.getItem('admin_token') || '';

    // Предпочтительно: RPC на бэке
    if(supabase.rpc){
      supabase.rpc('delete_series', { _series_id: seriesId, _admin_token: adminToken })
        .then(function(r){
          if(r.error || r.data!==true){ alert('Не удалось удалить серию'); return; }
          location.href = 'index.html';
        });
      return;
    }

    // Фолбэк: старый путь (при открытых RLS)
    supabase.from('frames').select('image_url').eq('series_id', seriesId).then(function(r){
      var imgs = (r.data||[]).map(function(f){ return extractStorageKeys(f.image_url); }).flat();
      var p = Promise.resolve(); if(imgs.length){ p = supabase.storage.from('Frames').remove(imgs); }
      p.then(function(){ return supabase.from('series').delete().eq('id', seriesId); })
       .then(function(r2){ if(r2.error){ alert('Не удалось удалить серию'); return; } location.href='index.html'; });
    });
  });

  // Стартовая загрузка
  loadSeries().then(syncAdminUI);
})();
</script>
</body>
</html>