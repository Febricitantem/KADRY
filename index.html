<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kadry ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <style>
    :root {
      --bg: #f4f4f5;
      --text: #0f172a;
      --muted: #64748b;
      --card: #fff;
      --stroke: #e5e7eb;
    }

    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }

    /* –®–∞–ø–∫–∞ –∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è */
    .site-header {
      position: relative;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: center;
      padding: 10px 18px 14px;
      background: #f8fafc;
      border-bottom: 1px solid var(--stroke);
      min-height: 65px;
    }
    .hslot {
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: inherit;
      font-weight: 600;
    }
    .hslot:hover {
      background: #e5e7eb40;
    }
    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1;
    }
    .brand .above {
      font-size: 30px;
      font-weight: 800;
      transform: translateY(-18%);
    }
    .brand .below {
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .04em;
      text-transform: uppercase;
      transform: translateY(18%);
    }

   .wrap{
  max-width:1200px;
  margin:22px auto;
  padding:0 18px;
}
    .loading-box{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:40px 0;
      color:#6b7280;
      font-size:15px;
      gap:6px;
    }
    .loading-cat{
      max-width:96px;
      height:auto;
    }


/* —Å—Ç—Ä–æ–∫–∞ "–ö–∞—Ç–∞–ª–æ–≥ —Å–µ—Ä–∏–π" + –∫–Ω–æ–ø–∫–∞ */
.catalog-header {
  display: grid;
  grid-template-columns: 320px 1fr 240px; /* –∫–∞–∫ series-row */
  align-items: center;
  column-gap: 24px;
  margin: 8px 0 18px;
  padding: 0 16px; /* –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∞–∫–∏–µ –∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–ª—è –∫–∞–∫ —É –∫–∞—Ä—Ç–æ—á–µ–∫ */
}

.catalog-header h1 {
  grid-column: 1 / span 2;
  margin: 0;
  font-size: 36px;
  font-weight: 800;
}

/* –ö–Ω–æ–ø–∫–∞ */
#open-create {
  grid-column: 3;
  justify-self: center;

  /* –†–∞–∑–º–µ—Ä –∫–∞–∫ —É –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫, –Ω–æ —á—É—Ç—å –≤—ã—à–µ */
  padding: 10px 20px;
  font-size: 15px;
  border-radius: 12px;

  /* –ß—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–∞ —Ç–∞–∫ –∂–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –∫–∞–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
  min-width: 160px;
  text-align: center;
}



    .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* –õ–µ–Ω—Ç–∞ —Å–µ—Ä–∏–∏ ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è: 1 —Å—Ç—Ä–æ–∫–∞, 3 –∫–æ–ª–æ–Ω–∫–∏ */
    .series-row{position:relative;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px 16px;margin-bottom:16px;display:grid;grid-template-columns:320px 1fr 240px;gap:24px;align-items:center;height:152px;overflow:hidden}
    @media (max-width:900px){.series-row{grid-template-columns:1fr;height:auto;align-items:start}.aside{align-items:flex-start;text-align:left;width:auto}.series-actions .btn,.series-title{width:100%}}

    /* col1: –ø—Ä–µ–≤—å—é/—Å—Ç–æ–ø–∫–∞ */
    .preview{grid-column:1;height:124px;width:100%;overflow:hidden;padding-left:12px;position:relative;display:flex;align-items:center;cursor:pointer}
    .stack{position:relative;height:124px;width:100%;overflow:hidden}
    .tile{position:absolute;top:0;left:0;width:220px;aspect-ratio:16/9;border:1px solid #e5e7eb;border-radius:10px;background:#f8fafc;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 2px rgba(0,0,0,.03);transition:transform 1s ease,left 1s ease,opacity 1s ease;will-change:left,transform}
    .tile img{width:100%;height:100%;object-fit:contain;display:block}
    .stack:not(.expanded) .tile{--shift:14px;left:calc(var(--i)*var(--shift));transform:translateX(calc(var(--i)*2px))}
    .stack:not(.expanded) .tile:not(:last-child){opacity:.92}
    .stack.expanded{position:relative;height:124px}
    .stack.expanded .tile{transform:none;cursor:pointer}
    .tile.ellipsis{position:relative}
    .tile.ellipsis img{filter:opacity(.3)}
    .tile.ellipsis::after{content:'‚Ä¶';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:42px;font-weight:900;color:#334155}

    /* col2: –æ–ø–∏—Å–∞–Ω–∏–µ */
    .series-desc{grid-column:2;grid-row:1;color:#475569;font-size:14px;text-align:center;display:flex;align-items:center;justify-content:center;height:124px;overflow:hidden;position:relative}
    .series-desc__inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;transition:opacity 1.8s ease, transform 1.4s ease}
    .series-row.expanded .series-desc__inner{opacity:0;transform:translateY(12px);pointer-events:none;transition:opacity .2s ease, transform .6s ease}

    /* col3: –ø—Ä–∞–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü ‚Äî –µ–¥–∏–Ω–∞—è –æ—Å—å: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –¥–≤–µ —Ä–∞–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .aside{grid-column:3;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;width:240px;height:124px}
    .series-title{font-size:20px;font-weight:800;margin:0 0 8px;text-align:center}
    .series-actions{display:flex;flex-direction:column;gap:10px;margin-top:6px;align-items:center}

    /* –û–≤–µ—Ä–ª–µ–π –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –æ–Ω–ª–∞–π–Ω–∞ */
    body.site-closed {
      overflow: hidden;
    }
    .site-closed-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(6px);
    }
    .site-closed-card {
      max-width: 420px;
      width: 100%;
      border-radius: 16px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 18px 18px 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.8);
      font-size: 14px;
    }
    .site-closed-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .site-closed-text {
      font-size: 14px;
      color: #cbd5f5;
    }

    /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
    .pagination {
  margin: 28px auto 40px;
  display: flex;
  align-items: center;
  gap: 18px;
  justify-content: center; /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º */
  font-size: 15px;
  color: #4b5563;
}
.pagination span {
  min-width: 140px;
  text-align: center;
}

    .pagination span {
      min-width: 140px;
    }
  </style>
 <!-- ‚¨á –Ω–∞—à –º–æ–±–∏–ª—å–Ω—ã–π —Ñ–∞–π–ª, —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö -->
  <link rel="stylesheet" href="mobile.css" media="(max-width: 768px)" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="admin.js"></script>
</head>
<body>

  <div id="site-closed-overlay" class="site-closed-overlay" style="display:none">
    <div class="site-closed-card">
      <div class="site-closed-title">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç</div>
      <div class="site-closed-text" id="site-closed-message">
        –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.
      </div>
    </div>
  </div>

  <header class="site-header">
    <div class="hslot h1">
      <div class="brand">
        <div class="above">–ö–∞—Ç–∞–ª–æ–≥</div>
        <div class="below">Kadry</div>
      </div>
    </div>
    <a class="hslot h2" href="index.html">–ö–∞—Ç–∞–ª–æ–≥</a>
    <a class="hslot h3" href="votes.html">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</a>
    <a class="hslot h4" href="#">–ü—Ä–æ—Ñ–∏–ª—å</a>
  </header>

 <div class="wrap">
  <div class="catalog-header">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ —Å–µ—Ä–∏–π</h1>
    <button id="open-create" class="btn primary">–°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–∏—é</button>
  </div>

    <div id="series-list" style="margin-top:14px">
      <div class="loading-box">
        <img src="KOTRUN.gif" alt="–ö–æ—Ç–∏–∫ –±–µ–∂–∏—Ç –∏ —Ç–∞—â–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É" class="loading-cat">
        <div id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞</div>
      </div>
    </div>


    <!-- üîπ –ù–û–í–û–ï: –±–ª–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
   <div style="width:100%; display:flex; justify-content:center;">
  <div id="pagination" class="pagination" style="display:none">
    <button class="btn" type="button" data-role="prev">‚Üê –ù–∞–∑–∞–¥</button>
    <button class="btn" type="button" data-role="next">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    <span data-role="label"></span>
  </div>
</div>


<script>
  // --- Supabase init ---
  const supabase = window.supabase.createClient(
    "https://upanhirmxhfzpajvswoq.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwYW5oaXJteGhmenBhanZzd29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjIwNzcsImV4cCI6MjA3MjIzODA3N30.HhrccU3DfoLadflBmTxIDXJgrDQB3m2zLRX3vtRycGA",
    {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        storageKey: "kadry-auth",
      },
    }
  );

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –æ–Ω–ª–∞–π–Ω ---
  async function checkSiteOpen() {
    let admin = false;
    if (typeof window.isAdmin === 'function') {
      try {
        admin = await window.isAdmin();
      } catch (e) {
        console.warn('[kadry][index] isAdmin() failed:', e);
      }
    }

    try {
      const { data, error } = await supabase
        .from('site_state')
        .select('id, is_open, announcement')
        .limit(1)
        .single();

      if (error) {
        console.warn('[kadry][index] site_state load error:', error);
        return;
      }

      const open = data && data.is_open !== false;

      if (!open && !admin) {
        const overlay = document.getElementById('site-closed-overlay');
        const messageEl = document.getElementById('site-closed-message');
        if (overlay) {
          if (messageEl) {
            messageEl.textContent =
              data.announcement || '–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.';
          }
          overlay.style.display = 'flex';
          document.body.classList.add('site-closed');
        }
      }
    } catch (e) {
      console.warn('[kadry][index] checkSiteOpen failed:', e);
    }
  }
  checkSiteOpen();

  // --- Helpers ---
  const descriptionPlaceholders = [
    'Hello, world!',
    'It works!',
    '–ù–µ —Å—É–¥–∏—Ç–µ —Å—Ç—Ä–æ–≥–æ.',
    '–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ –º–æ—è —Å–µ—Ä–∏—è!',
    '–í—ã –∫–∞–¥—Ä ‚Ññ‚Ä¶',
    '–ï—Å–ª–∏ –≤—ã —ç—Ç–æ —á–∏—Ç–∞–µ—Ç–µ ‚Äî –∑–Ω–∞—á–∏—Ç –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç.'
  ];

  const signedCache = new Map();
    let loadingTimer = null;

  function showLoading(host){
    host.innerHTML = `
      <div class="loading-box">
        <img src="KOTRUN.gif" alt="–ö–æ—Ç–∏–∫ –±–µ–∂–∏—Ç –∏ —Ç–∞—â–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É" class="loading-cat">
        <div id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞</div>
      </div>
    `;

    if (loadingTimer) {
      clearInterval(loadingTimer);
      loadingTimer = null;
    }

    const textEl = host.querySelector('#loadingText');
    if (textEl) {
      const base = '–ó–∞–≥—Ä—É–∑–∫–∞';
      let dots = 0;
      loadingTimer = setInterval(() => {
        dots = (dots + 1) % 4; // 0..3
        textEl.textContent = base + (dots ? '.'.repeat(dots) : '');
      }, 400);
    }
  }

  async function getDisplayUrl(storedUrl){
    try{
      if(!storedUrl) return storedUrl;
      if(storedUrl.includes('token=')) return storedUrl;
      if(signedCache.has(storedUrl)) return signedCache.get(storedUrl);
      const anchor='/storage/v1/object/';
      let rest=null; const i=storedUrl.indexOf(anchor);
      if(i!==-1) rest=storedUrl.substring(i+anchor.length);
      if(!rest && storedUrl.includes('/Frames/')) rest='Frames/'+storedUrl.split('/Frames/')[1];
      if(!rest) return storedUrl;
      if(rest.startsWith('public/')) rest=rest.substring(7);
      if(rest.startsWith('sign/'))   rest=rest.substring(5);
      const b=rest.indexOf('Frames/');
      if(b===-1) return storedUrl;
      const path=rest.substring(b+'Frames/'.length);
      const { data, error } = await supabase.storage.from('Frames').createSignedUrl(path,3600);
      if(!error && data?.signedUrl){ signedCache.set(storedUrl,data.signedUrl); return data.signedUrl; }
    }catch(e){ console.warn('getDisplayUrl error',e); }
    return storedUrl;
  }

  // --- –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Ä–∏–∏ ---
  (function(){
    const btnOpen = document.getElementById('open-create');
    if(btnOpen){
      btnOpen.addEventListener('click', (e)=>{
        e.preventDefault();
        location.href = 'editor.html?mode=new';
      });
    }
  })();

  // --- –ü–ê–ì–ò–ù–ê–¶–ò–Ø ---
  const PAGE_SIZE = 10;
  let currentPage = 1;
  let totalPages = 1;

  function setupPagination() {
    const pag = document.getElementById('pagination');
    if (!pag) return;
    const prevBtn = pag.querySelector('[data-role="prev"]');
    const nextBtn = pag.querySelector('[data-role="next"]');

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          loadSeries(currentPage - 1);
        }
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          loadSeries(currentPage + 1);
        }
      });
    }
  }

  function updatePaginationUI() {
    const pag = document.getElementById('pagination');
    if (!pag) return;

    const label = pag.querySelector('[data-role="label"]');
    const prevBtn = pag.querySelector('[data-role="prev"]');
    const nextBtn = pag.querySelector('[data-role="next"]');

    if (totalPages <= 1) {
      pag.style.display = 'none';
      return;
    }

    pag.style.display = 'flex';

    if (label) {
      label.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
    }
    if (prevBtn) {
      prevBtn.disabled = currentPage <= 1;
    }
    if (nextBtn) {
      nextBtn.disabled = currentPage >= totalPages;
    }
  }

  // --- –†–µ–Ω–¥–µ—Ä –æ–¥–Ω–æ–π —Å–µ—Ä–∏–∏ (–≤—ã–Ω–µ—Å–µ–Ω–æ –≤ —Ñ—É–Ω–∫—Ü–∏—é) ---
  async function renderSeriesRow(s, host) {
    // –ë–µ—Ä—ë–º –∫–∞–¥—Ä—ã: —Å–Ω–∞—á–∞–ª–∞ committed, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî –∫–∞–¥—Ä—ã in_vote
    const { data: allFrames } = await supabase
      .from('frames')
      .select('id,image_url,order_index,committed,in_vote')
      .eq('series_id', s.id)
      .or('committed.eq.true,in_vote.eq.true')
      .order('order_index',{ascending:true,nullsFirst:false})
      .order('id',{ascending:true});

    const committed = (allFrames||[]).filter(f=>f.committed);
    const inVote    = (allFrames||[]).filter(f=>!f.committed && f.in_vote);
    const previewFrames = committed.length ? committed : inVote;

    const row=document.createElement('div'); row.className='series-row';

    // col1: preview/stack
    const preview=document.createElement('div'); preview.className='preview';
    preview.setAttribute('role','link');
    preview.setAttribute('aria-label', `–û—Ç–∫—Ä—ã—Ç—å —Å–µ—Ä–∏—é ${s.title}`);
    preview.tabIndex = 0;
    const goSeries = ()=>{ location.href = `series.html?id=${s.id}`; };
    const keyGo = (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); goSeries(); } };
    preview.addEventListener('click', goSeries);
    preview.addEventListener('keydown', keyGo);

    const stack=document.createElement('div'); stack.className='stack'; preview.appendChild(stack);
    let i=0;
    const stackFrames=[];
    if(previewFrames.length>0) stackFrames.push(previewFrames[0]);
    if(previewFrames.length>1) stackFrames.push(previewFrames[Math.min(1,previewFrames.length-1)]);
    if(previewFrames.length>3){
      stackFrames.push({ id:'ellipsis', image_url: previewFrames[2]?.image_url || '' });
      stackFrames.push(previewFrames[previewFrames.length-2]);
      stackFrames.push(previewFrames[previewFrames.length-1]);
    } else if(previewFrames.length>2) {
      stackFrames.push(previewFrames[previewFrames.length-1]);
    }

    for(const p of stackFrames){
      const t=document.createElement('div'); t.className='tile'; t.style.setProperty('--i', i++);
      const img=document.createElement('img'); img.loading='lazy';
      if(p.image_url) getDisplayUrl(p.image_url).then(u=>{ img.src=u; });
      t.appendChild(img);
      if(p.id==='ellipsis'){ t.classList.add('ellipsis'); }
      stack.appendChild(t);
    }

    (function initCompact(){
      const tiles=Array.from(stack.querySelectorAll('.tile'));
      const shift=14;
      tiles.forEach((t,idx)=>{ t.style.transition='none'; t.style.left=(idx*shift)+'px'; });
      requestAnimationFrame(()=> tiles.forEach(t=>{ t.style.transition='transform 1s ease, left 1s ease, opacity 1s ease'; }));
    })();

    // col2: description
    const desc=document.createElement('div');
    desc.className='series-desc';
    const descText = (s.description && s.description.trim())
      ? (s.description||'')
      : descriptionPlaceholders[Math.floor(Math.random()*descriptionPlaceholders.length)];
    const safe = descText.replace(/[<>]/g, m=>({"<":"&lt;",">":"&gt;"}[m]));
    const descHtml = `<div class="series-desc__inner">${safe}</div>`;
    desc.innerHTML = descHtml;

    // col3: aside
    const aside=document.createElement('div'); aside.className='aside';
    const h=document.createElement('div'); h.className='series-title'; h.textContent=s.title; aside.appendChild(h);
    const actions=document.createElement('div'); actions.className='series-actions';
    const btnVote=document.createElement('button'); btnVote.className='btn vote'; btnVote.textContent='–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ'; btnVote.onclick=()=>{ location.href=`vote.html?series=${s.id}`; };
    const btnOpen=document.createElement('button'); btnOpen.className='btn primary open'; btnOpen.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å–µ—Ä–∏—é'; btnOpen.onclick=()=>{ location.href=`series.html?id=${s.id}`; };
    actions.appendChild(btnVote); actions.appendChild(btnOpen); aside.appendChild(actions);

    // --- Hover behaviour ---
    let hoverTimer=null; let expanded=false;

    function expand(){
      if(expanded) return; expanded=true;
      const tiles=Array.from(stack.querySelectorAll('.tile'));
      const shift=14;
      tiles.forEach((t,idx)=>{ t.style.transition='none'; t.style.left=(idx*shift)+'px'; });

      const rowRect   = row.getBoundingClientRect();
      const asideRect = aside.getBoundingClientRect();
      const gap = 24;
      const leftOffset = stack.offsetLeft;
      const topOffset  = stack.offsetTop;
      const targetWidth = Math.max(0, (asideRect.left - rowRect.left) - (preview.offsetLeft + leftOffset) - gap);

      stack.dataset.prevPos = stack.style.position;
      stack.dataset.prevW   = stack.style.width;
      stack.dataset.prevL   = stack.style.left;
      stack.dataset.prevT   = stack.style.top;
      const prevOv = preview.style.overflow; preview.dataset.prevOv = prevOv; preview.style.overflow = 'visible';
      stack.style.position = 'absolute';
      stack.style.left = leftOffset + 'px';
      stack.style.top  = topOffset  + 'px';
      stack.style.width = targetWidth + 'px';
      stack.style.height = stack.offsetHeight + 'px';

      row.classList.add('expanded'); stack.classList.add('expanded');
      void stack.offsetWidth;

      tiles.forEach(t=>{ t.style.transition='transform 1s ease, left 1s ease, opacity 1s ease'; });
      const n=tiles.length; if(n===0) return;
      const tileW=tiles[0].getBoundingClientRect().width;
      const avail=Math.max(0, targetWidth - tileW);
      const overlap=8;
      const baseSlots = 5;
      const step5 = (baseSlots>1) ? Math.max(0,(avail - overlap*(baseSlots-1))/(baseSlots-1)) : 0;
      const step = step5;
      tiles.forEach((t,idx)=>{ t.style.left = (idx*step + idx*overlap) + 'px'; });
      tiles.forEach(t=>{
        if(!t.dataset.clickable){
          t.addEventListener('click', goSeries);
          t.addEventListener('keydown', keyGo);
          t.dataset.clickable='1';
        }
        t.tabIndex = 0;
        t.style.cursor='pointer';
      });
    }

    function collapse(){
      if(!expanded) return; expanded=false;
      const tiles=Array.from(stack.querySelectorAll('.tile'));
      row.classList.remove('expanded'); stack.classList.remove('expanded');
      const shift=14;
      tiles.forEach((t,idx)=>{ t.style.left=(idx*shift)+'px'; t.tabIndex=-1; });
      const finish=()=>{
        tiles.forEach(t=> t.removeEventListener('transitionend', finish));
        tiles.forEach(t=>{ t.style.transition='none'; });
        stack.style.position = stack.dataset.prevPos || '';
        stack.style.width    = stack.dataset.prevW   || '';
        stack.style.left     = stack.dataset.prevL   || '';
        stack.style.top      = stack.dataset.prevT   || '';
        preview.style.overflow = preview.dataset.prevOv || 'hidden';
        requestAnimationFrame(()=> tiles.forEach(t=>{ t.style.transition='transform 1s ease, left 1s ease, opacity 1s ease'; }));
      };
      tiles.forEach(t=> t.addEventListener('transitionend', finish, { once:true }));
    }

    function isInsideActiveArea(evt){
      const rowRect = row.getBoundingClientRect();
      const asideRect = aside.getBoundingClientRect();
      const x = evt.clientX, y = evt.clientY;
      const left = rowRect.left + 8;
      const right = asideRect.left - 12;
      const top = rowRect.top + 6, bottom = rowRect.bottom - 6;
      return x>=left && x<=right && y>=top && y<=bottom;
    }
    function isInsidePreview(evt){
      const r = preview.getBoundingClientRect();
      const x = evt.clientX, y = evt.clientY;
      return x>=r.left && x<=r.right && y>=r.top && y<=r.bottom;
    }

    row.addEventListener('mouseenter',(e)=>{ if(isInsidePreview(e)) { expand(); } });
    row.addEventListener('mousemove',(e)=>{
      const inActive = isInsideActiveArea(e);
      if(expanded){ row.style.cursor = inActive ? 'pointer' : 'default'; }
      else { row.style.cursor = 'default'; }
      if(inActive){
        if(isInsidePreview(e)){
          if(hoverTimer){ clearTimeout(hoverTimer); hoverTimer=null; }
          if(!expanded) expand();
        }else{ if(hoverTimer){ clearTimeout(hoverTimer); hoverTimer=null; } }
      }else{ if(!hoverTimer){ hoverTimer=setTimeout(collapse, 120); } }
    });
    row.addEventListener('mouseleave',()=>{ if(hoverTimer){ clearTimeout(hoverTimer);} collapse(); });

    row.addEventListener('click',(e)=>{
      if(!expanded) return;
      const rowRect = row.getBoundingClientRect();
      const asideRect = aside.getBoundingClientRect();
      const x=e.clientX, y=e.clientY;
      const inActive = x>=rowRect.left+8 && x<=asideRect.left-12 && y>=rowRect.top+6 && y<=rowRect.bottom-6;
      if(inActive) { e.preventDefault(); goSeries(); }
    });

    requestAnimationFrame(()=>{
      const openW = btnOpen.offsetWidth;
      const voteW = btnVote.offsetWidth;
      const target = Math.max(openW, voteW);
      btnOpen.style.width = target+'px';
      btnVote.style.width = target+'px';
      h.style.width = target+'px';
    });

    row.appendChild(preview);
    row.appendChild(desc);
    row.appendChild(aside);
    host.appendChild(row);
  }

  // --- Main list loader —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π ---
  async function loadSeries(page = 1){
    const host=document.getElementById('series-list');
    const pag = document.getElementById('pagination');

    currentPage = page;
    showLoading(host);


    if (pag) {
      pag.style.visibility = 'hidden';
    }

    const from = (page - 1) * PAGE_SIZE;
    const to   = from + PAGE_SIZE - 1;

    const { data: series, error, count } = await supabase
      .from('series')
      .select('*', { count: 'exact' })
      .order('created_at',{ascending:false})
      .range(from, to);

    if(error){
      console.error(error);
      if (loadingTimer) {
        clearInterval(loadingTimer);
        loadingTimer = null;
      }
      host.textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      return;
    }

    totalPages = count ? Math.max(1, Math.ceil(count / PAGE_SIZE)) : 1;

    if (loadingTimer) {
      clearInterval(loadingTimer);
      loadingTimer = null;
    }
    host.textContent='';

    for (const s of (series || [])) {
      await renderSeriesRow(s, host);
    }

    updatePaginationUI();
    if (pag) {
      pag.style.visibility = 'visible';
    }
  }

  // –°—Ç–∞—Ä—Ç
  setupPagination();
  loadSeries(1);
</script>
</body>
</html>
