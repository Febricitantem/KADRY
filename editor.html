<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kadry ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä</title>
  <!-- –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.
       –í–ê–ñ–ù–û: –≤–µ—Ä–Ω—É–ª–∏ —Ü–µ–ª–æ—Å—Ç–Ω—É—é —Ä–∞–∑–º–µ—Ç–∫—É –∏ —Ä–∞–±–æ—á–∏–π —Ö–æ–ª—Å—Ç.
       –õ–æ–≥–∏–∫—É —Ç–∞–π–º–µ—Ä–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º –º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
       –¥–∞–ª—å—à–µ, –Ω–æ —ç—Ç—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç—Ä–æ–≥–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ. -->
  <style>
    :root {
      --bg: #f4f4f5;
      --text: #0f172a;
      --muted: #64748b;
      --card: #fff;
      --stroke: #e5e7eb;
      --accent: #0f172a;
      --accent-ink: #fff;
    }

    html,body{height:100%; margin:0;}
    body{background:#f4f4f5; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:#111827; overflow:auto;}
    body{background:#f4f4f5; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:#111827;}

    header{margin:0;} /* –±–∞–∑–æ–≤—ã–π reset, –æ—Å–Ω–æ–≤–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —É .site-header */
    header a{color:#a5b4fc; text-decoration:none}
    header a:hover{text-decoration:underline}
    header .grow{flex:1}
    .site-header {
  position:relative;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  align-items:center;
  padding:4px 14px 6px; /* —É–º–µ–Ω—å—à–∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
  background:#f8fafc;
  border-bottom:1px solid var(--stroke);
  min-height:58px; /* —É–≤–µ–ª–∏—á–µ–Ω–æ —Ä–æ–≤–Ω–æ –Ω–∞—Å—Ç–æ–ª—å–∫–æ, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –Ω–∏–∂–Ω—é—é "–¥—ã—Ä—É" –±–µ–∑ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞ */ /* –±—ã–ª–æ 65px ‚Üí –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
}
    .hslot{display:flex;align-items:center;justify-content:center;text-decoration:none;color:inherit;font-weight:600;}
    .brand{display:flex;flex-direction:column;align-items:center;line-height:1;}
    .brand .above{font-size:30px;font-weight:800;transform:translateY(-18%);}
    .brand .below{font-size:14px;color:var(--muted);letter-spacing:.04em;text-transform:uppercase;transform:translateY(18%);}
    .topbar-timer {
      margin-left:auto;
      margin-right:12px;
      display:flex;
      align-items:center;
      gap:6px;
    }
      
.slider-value{
  margin-left:4px;
  font-size:12px;
  color:#6b7280;
  min-width:32px;
  display:inline-block;
  text-align:right;
}

    .timer-badge {
      display:inline-block;
      min-width:72px;
      text-align:center;
      padding:4px 10px;
      border-radius:999px;
      background:#334155;
      color:#ffffff;
      font-weight:700;
      font-size:14px;
      letter-spacing:.03em;
    }

    .timer-badge.warn{background:#f59e0b;}
    .timer-badge.danger{background:#ef4444;}
    .timer-badge{display:inline-block;min-width:120px;text-align:center;padding:6px 12px;border-radius:8px;background:#334155;color:#ffffff;font-weight:800;letter-spacing:.5px;}
    .timer-badge.warn{background:#f59e0b;color:#ffffff;}
    .timer-badge.danger{background:#ef4444;color:#ffffff;}

    .admin-chip{display:none; margin-left:8px; padding:4px 8px; border-radius:8px; border:1px dashed #94a3b8; color:#cbd5e1; font-size:12px}
    .admin-btn{display:none; margin-left:8px; padding:4px 10px; border-radius:8px; border:1px solid #c2410c; background:#7c2d12; color:#fff; cursor:pointer}

    .wrap{height:calc(100% - 70px); display:flex;}

    .side{width:280px; min-width:280px; border-right:1px solid #e5e7eb; background:#fff; overflow:hidden; padding:12px; display:flex; flex-direction:column; gap:12px;}
    .panel{background:#f7f7f9; border:1px solid #e5e7eb; border-radius:8px; padding:10px;}
    .panel-title{font-weight:700; margin-bottom:8px; font-size:14px;}
    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:8px; width:100%;}
    .divider{height:1px; background:#e5e7eb; margin:8px 0}
    .btn{padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer}
    .btn.primary{background:#2563eb; color:#fff; border-color:#2563eb}
    .btn.add{background:#22c55e; color:#fff; border-color:#16a34a; font-weight:600;}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    #layerList{max-height:260px; overflow-y:auto; padding-right:4px;}

        .stage{flex:1; display:flex; flex-direction:column; overflow:hidden}
    .topbar{display:flex; align-items:center; gap:14px; padding:8px 16px; background:#fff; border-bottom:1px solid #e5e7eb}
    .canvas-holder{
      flex:1;
      display:flex;
      align-items:stretch;
      justify-content:center;
      overflow:hidden;
      padding:12px;
      gap:12px;
    }
    #canvasWrap{
      position:relative;
      background:#fff;
      border:1px solid #ddd;
      width:100%;
      height:auto;
      flex:1 1 auto;
    }
   .color-preview{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:70px;
  height:70px;
  border-radius:999px;
  border:3px solid rgba(15,23,42,0.8);
  box-shadow:0 4px 16px rgba(15,23,42,0.35);
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.12s ease-out;
  z-index:9999;
}
body.eyedropper-active #canvasWrap{
  cursor: crosshair;
}
/* –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∏–ø–µ—Ç–∫–µ –ø—É–∑—ã—Ä—å-–ø—Ä–µ–≤—å—é –≤—ã–∫–ª—é—á–∞–µ–º,
   —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–≤–∞–ª—Å—è ‚Äú–∫—Ä—É–∂–æ–∫ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞‚Äù */
body.eyedropper-active .color-preview{
  opacity:0 !important;
}



    .color-sidebar{
      width:260px;
      max-width:260px;
      flex:0 0 auto;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .color-wheel-wrap{
  position:relative;          /* ‚Üê –¥–æ–±–∞–≤–∏–ª–∏ */
  display:flex;
  justify-content:center;
  align-items:center;
}



        .eyedropper-btn{
      position:absolute;
      right:-10px;
      top:50%;
      transform:translateY(-50%);
      width:32px;
      height:32px;
      border-radius:50%;
      border:2px solid #111827;
      background:#ffffff;
      color:#111827;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 6px rgba(15,23,42,0.15);
    }
    .eyedropper-btn:hover{
      background:#f3f4ff;
    }



    #colorWheel{
      max-width:100%;
      height:auto;
      display:block;
    }
    .color-sliders{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .color-slider-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:#374151;
    }
    .color-slider-row span{
      width:14px;
      text-align:right;
    }
    .color-slider-row input[type=range]{
      -webkit-appearance:none;
      appearance:none;
      width:100%;
      height:100%;
      background:transparent;
      margin:0;
      padding:0;
    }
    .color-slider-track{
      position:relative;
      flex:1;
      height:16px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #d1d5db;
      background:#000; /* –±—É–¥–µ—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º –∏–∑ JS */
    }
    .color-slider-track::before{
      content:'';
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius:inherit;
      background:transparent;
    }
    .color-slider-track input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:10px;
      height:16px;
      border-radius:3px;
      background:#f9fafb;
      border:1px solid #111827;
      box-shadow:0 0 0 1px rgba(255,255,255,0.6);
      cursor:pointer;
    }
    .color-slider-track input[type=range]::-moz-range-thumb{
      width:10px;
      height:16px;
      border-radius:3px;
      background:#f9fafb;
      border:1px solid #111827;
      cursor:pointer;
    }
    .color-slider-track input[type=range]::-ms-thumb{
      width:10px;
      height:16px;
      border-radius:3px;
      background:#f9fafb;
      border:1px solid #111827;
      cursor:pointer;
    }
    .color-history{
      margin-top:6px;
      display:flex;
      gap:8px;
    }
    .color-history-col{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .color-history-swatch{
      width:100%;
      height:24px;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#ffffff;
      cursor:pointer;
      padding:0;
    }
    .color-history-swatch:focus-visible{
      outline:2px solid #0ea5e9;
      outline-offset:1px;
    }
    #canvasWrap canvas{width:100%; height:100%; display:block;}
    .bottombar{display:flex; justify-content:center; align-items:center; gap:10px; padding:10px; background:#fff; border-top:1px solid #e5e7eb}

    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:10000; backdrop-filter:blur(2px);} 
    .overlay.show{display:flex}
    body.modal-open{overflow:hidden;}
    body.modal-open #canvasWrap{pointer-events:none;}
    body.modal-open #canvasWrap canvas:last-of-type{display:none !important;}
    .card{width:min(560px, 92vw); max-width:92vw; background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.18); padding:20px; position:relative}
    .card h3{margin:0 0 10px; font-size:20px; font-weight:800}
    .card .x{position:absolute; top:8px; right:10px; border:0; background:transparent; font-size:20px; cursor:pointer}
    .card p{margin:8px 0 0 0;}
    .actions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    .danger{color:#ef4444}
        .save-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .save-form label {
      font-size: 14px;
      font-weight: 600;
    }

    .save-form input[type="text"],
    .save-form textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 14px;
    }

    .save-form textarea {
      min-height: 80px;
      resize: vertical;
    }


    body.time-expired #canvasWrap{pointer-events:none; filter:grayscale(.1);} /* –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ —Ç–∞–π–º–µ—Ä—É */
  
    body.site-closed {
      overflow: hidden;
    }
    .site-closed-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(6px);
    }
    .site-closed-card {
      max-width: 420px;
      width: 100%;
      border-radius: 16px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 18px 18px 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.8);
      font-size: 14px;
    }
    .site-closed-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .site-closed-text {
      font-size: 14px;
      color: #cbd5f5;
    }
    /* === –°–ø—Ä–∞–≤–∫–∞: –ø–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–∫–Ω–æ === */

/* –ö–Ω–æ–ø–∫–∞ "–°–ø—Ä–∞–≤–∫–∞" –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞ */
.help-fab {
  position: fixed;
  right: 16px;
  bottom: 16px;
  z-index: 9000; /* –Ω–∏–∂–µ –º–æ–¥–∞–ª–æ–∫ (.overlay z-index:10000) */
  box-shadow: 0 4px 12px rgba(15,23,42,0.35);
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ */
/* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ */
.help-card {
  max-width: min(760px, 96vw);
  max-height: min(520px, 90vh);
  display: grid;
  grid-template-columns: 3fr 1.2fr; /* —Ç–µ–∫—Å—Ç + –∫–æ–ª–æ–Ω–∫–∞ –ø–æ–¥ –∫–æ—Ç–æ–≤ */
  grid-template-rows: auto auto 1fr auto;
  gap: 8px 16px;
  overflow: hidden; /* –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ª–µ–∑–∞–µ—Ç –∑–∞ —Ä–∞–º–∫—É */
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ */
.help-title {
  grid-column: 1 / 3;
  text-align: center;
  margin: 0 0 4px;
  font-size: 20px;
  font-weight: 800;
}

.help-subtitle {
  grid-column: 1 / 3;
  text-align: center;
  margin: 0 0 6px;
  font-size: 13px;
  color: #6b7280;
}

/* –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø—Ä–∞–≤–∫–∏ (–ª–µ–≤–∞—è —á–∞—Å—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º) */
.help-content {
  grid-column: 1 / 2;
  grid-row: 3 / 5;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 0; /* –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω—É—Ç—Ä–∏ */
}

/* –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º */
.help-scroll {
  flex: 1 1 auto;
  overflow-y: auto;
  padding-right: 8px;
  margin-top: 0;
  min-height: 0;

  /* –ø—Ä—è—á–µ–º –ø–æ–ª–æ—Å–∫—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∞–º —Å–∫—Ä–æ–ª–ª */
  scrollbar-width: none;          /* Firefox */
}
.help-scroll::-webkit-scrollbar { /* Chrome, Edge, Safari */
  width: 0;
  height: 0;
}


/* –°—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø—Ä–∞–≤–∫–∏ (–ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏) */
.help-page {
  display: none;
}
.help-page.active {
  display: block;
}

/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º */
.help-pager {
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  font-size: 13px;
}

.help-pager button {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid #cbd5e1;
  background: #f9fafb;
  cursor: pointer;
}
.help-pager button:disabled {
  opacity: 0.5;
  cursor: default;
}

/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –ø–æ–¥ –∫–æ—Ç–∏–∫–æ–≤ */
.help-side {
  grid-column: 2 / 3;
  grid-row: 3 / 5;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding-right: 4px;
  padding-bottom: 4px;
  pointer-events: none;
}

/* –ö–æ—Ç –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ */
.help-cat {
  max-width: 100%;
  height: auto;
  display: none; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–ø—Ä—è—Ç–∞–Ω—ã, –≤–∫–ª—é—á–∞–µ–º –≤ JS */
}

/* –ö–æ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª) */
.help-cat-secondary {
  max-width: 100%;
  height: auto;
  margin-top: auto;
  display: none;
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 640px) {
  .help-card {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr auto auto;
    max-height: min(480px, 90vh);
  }

  .help-content {
    grid-column: 1 / 2;
    grid-row: 3 / 5;
  }

  .help-side {
    grid-column: 1 / 2;
    grid-row: 5 / 6;
    flex-direction: row;
    justify-content: center;
    gap: 12px;
  }

  .help-cat,
  .help-cat-secondary {
    max-width: 120px;
    opacity: 0.85;
  }
}


</style>

  <!-- CDN Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1"></script>
  <!-- –ê–¥–º–∏–Ω-—Å–∫—Ä–∏–ø—Ç -->
  <script src="admin.js"></script>
  <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
  <script src="draw.js"></script>
</head>
<body>

  <div id="site-closed-overlay" class="site-closed-overlay" style="display:none">
    <div class="site-closed-card">
      <div class="site-closed-title">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç</div>
      <div class="site-closed-text" id="site-closed-message">
        –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.
      </div>
    </div>
  </div>

  <header class="site-header">
    <div class="hslot h1">
      <div class="brand">
        <div class="above">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
        <div class="below">Kadry</div>
      </div>
    </div>
    <a class="hslot h2" href="index.html">–ö–∞—Ç–∞–ª–æ–≥</a>
    <a class="hslot h3" href="votes.html">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</a>
    <a class="hslot h4" href="#">–ü—Ä–æ—Ñ–∏–ª—å</a>
    <span id="adminBadge" class="admin-chip">ADMIN</span>
    <button id="admin10sBtn" class="admin-btn" title="–°–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä –¥–æ 10 —Å–µ–∫—É–Ω–¥">‚è± 10s</button>
  </header>

  <div class="wrap">
    <aside class="side">
      <a id="backSeries" href="#" class="btn" style="margin-bottom:8px; text-align:left;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Å–µ—Ä–∏—é</a>
      <div class="panel">
        <div class="panel-title">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–ª–æ—è</div>
        <div class="col">
          <input id="layerOpacity" name="layerOpacity" type="range" min="0" max="1" step="0.01" value="1" title="–ù–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—è" style="width:100%"/>
          <div class="row" style="justify-content:space-between;">
            <button id="addLayerBtn" class="btn add" title="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–π">Ôºã</button>
            <div style="display:flex; gap:8px;">
              <button id="clearBtn" class="btn" title="–û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ–π">√ó</button>
              <button id="delLayerBtn" class="btn" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–π" style="color:#ef4444">‚úñ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">–°–ª–æ–∏</div>
        <div id="layerList"></div>
      </div>

      <div class="panel">
        <div class="panel-title">–†–µ—Ñ–µ—Ä–µ–Ω—Å —Å–ª–æ–π</div>
        <div class="row">
          <input type="file" id="refInput" name="refInput" accept="image/*" class="btn"/>
          <button id="addRefBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ —Å–ª–æ–π</button>
        </div>
        <div class="ghost">–†–µ—Ñ–µ—Ä–µ–Ω—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∏ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.
        <br/>–í—Å–µ —Å–ª–æ–∏, <b class="danger">–æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∫—Ä–∞—Å–Ω—ã–º</b>, –Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.</div>
      </div>
    </aside>

    <main class="stage">
            <div class="topbar">
  <input id="brushColor" name="brushColor" type="hidden" value="#000000">

  <label>
    –¢–æ–ª—â–∏–Ω–∞
    <span id="brushSizeValue" class="slider-value">
      0%
    </span>
    <input
      id="brushSize"
      name="brushSize"
      type="range"
      min="1"
      max="60"
      value="8"
    >
  </label>

  <label>
    –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫–∏—Å—Ç–∏
    <span id="brushAlphaValue" class="slider-value">
      100%
    </span>
    <input
      id="brushAlpha"
      name="brushAlpha"
      type="range"
      min="0"
      max="1"
      step="0.01"
      value="1"
    >
  </label>

  <label>
    –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
    <span id="brushSmoothValue" class="slider-value">
      0%
    </span>
    <input
      id="brushSmooth"
      name="brushSmooth"
      type="range"
      min="0"
      max="100"
      step="1"
      value="0"
    >
  </label>

  <label>
    –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    <select id="toolSel" name="toolSel">
      <option value="brush">–ö–∏—Å—Ç—å</option>
      <option value="eraser">–õ–∞—Å—Ç–∏–∫</option>
      <option value="fill">–ó–∞–ª–∏–≤–∫–∞</option>
      <option value="select">–í—ã–¥–µ–ª–µ–Ω–∏–µ</option>
      <option value="zoom">–õ—É–ø–∞</option>
      <option value="eyedropper">–ü–∏–ø–µ—Ç–∫–∞</option>
    </select>
  </label>

  <div id="timerContainer" class="topbar-timer" aria-live="polite"></div>
  <button id="saveDrawBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>


<div class="canvas-holder">

  <div id="canvasWrap" aria-label="–†–∞–±–æ—á–∏–π —Ö–æ–ª—Å—Ç (–≤–Ω—É—Ç—Ä–∏ 1920√ó1080)">
    <div id="colorPreview" class="color-preview" aria-hidden="true"></div>
  </div>

  <aside class="color-sidebar" aria-label="–ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤">
    <div class="color-wheel-wrap">
      <canvas id="colorWheel" width="220" height="220"></canvas>

      <!-- –ö–Ω–æ–ø–∫–∞ –ø–∏–ø–µ—Ç–∫–∏ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ wrap, —á—Ç–æ–±—ã draw.js –µ—ë —É–≤–∏–¥–µ–ª -->
      <button
        id="eyedropperBtn"
        class="eyedropper-btn"
        type="button"
        title="–ü–∏–ø–µ—Ç–∫–∞ (–≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ P / –ó)"
      >
        üß™
      </button>
    </div>



    <div class="color-sliders">
      <div class="color-slider-row">
        <span>H</span>
        <div class="color-slider-track" data-kind="h">
          <input id="hueSlider" type="range" min="0" max="360" value="0">
        </div>
      </div>
      <div class="color-slider-row">
        <span>S</span>
        <div class="color-slider-track" data-kind="s">
          <input id="satSlider" type="range" min="0" max="100" value="100">
        </div>
      </div>
      <div class="color-slider-row">
        <span>B</span>
        <div class="color-slider-track" data-kind="b">
          <input id="valSlider" type="range" min="0" max="100" value="100">
        </div>
      </div>
    </div>

    <div class="color-history" aria-label="–ò—Å—Ç–æ—Ä–∏—è —Ü–≤–µ—Ç–æ–≤">
      <div class="color-history-col">
        <button class="color-history-swatch" data-index="0"></button>
        <button class="color-history-swatch" data-index="1"></button>
        <button class="color-history-swatch" data-index="2"></button>
        <button class="color-history-swatch" data-index="3"></button>
        <button class="color-history-swatch" data-index="4"></button>
      </div>
      <div class="color-history-col">
        <button class="color-history-swatch" data-index="5"></button>
        <button class="color-history-swatch" data-index="6"></button>
        <button class="color-history-swatch" data-index="7"></button>
        <button class="color-history-swatch" data-index="8"></button>
        <button class="color-history-swatch" data-index="9"></button>
      </div>
    </div>

  </aside>

</div>

      <div class="bottombar">
        <button
          id="confirmSelBtn"
          class="btn add"
          title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ"
          style="display:none; margin-right:24px;"
        >
          ‚úî
        </button>

        <button id="undoBtn" class="btn" title="–û—Ç–º–µ–Ω–∞">‚üµ</button>
        <button id="redoBtn" class="btn" title="–ü–æ–≤—Ç–æ—Ä">‚ü∂</button>

              <button
          id="helpBtn"
          class="btn help-fab"
          type="button"
          title="–°–ø—Ä–∞–≤–∫–∞ –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º –∏ —Ç–∞–π–º–µ—Ä—É"
        >
          –°–ø—Ä–∞–≤–∫–∞
        </button>


        <button
          id="cancelSelBtn"
          class="btn"
          title="–û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è"
          style="display:none; margin-left:24px; color:#ef4444;"
        >
          ‚úñ
        </button>
      </div>

    </main>
  </div>

  <div id="saveOverlay" class="overlay" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
      <button class="x" id="saveClose" title="–°–≤–µ—Ä–Ω—É—Ç—å –æ–∫–Ω–æ">‚úï</button>
      <h3 id="saveTitle">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Ä–∏–∏</h3>

      <div class="save-form">
        <label for="seriesTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏</label>
        <input
          id="seriesTitle"
          name="seriesTitle"
          type="text"
          placeholder="–î–æ 20 —Å–∏–º–≤–æ–ª–æ–≤"
          maxlength="20"
        />

        <label for="seriesDesc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea
          id="seriesDesc"
          name="seriesDesc"
          placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –∏–¥–µ—é —Å–µ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
          rows="4"
        ></textarea>
      </div>

      <div class="actions">
        <button id="doSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>


  <div id="timeUpOverlay" class="overlay" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="timeUpTitle">
      <h3 id="timeUpTitle">–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ</h3>
      <p>–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫?</p>
      <div class="actions">
        <button id="timeSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="timeExit" class="btn">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <div id="confirmExitOverlay" class="overlay" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="confirmExitTitle">
      <h3 id="confirmExitTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p class="danger">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–∞—à–∞ —Ä–∞–±–æ—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞!</p>
      <div class="actions">
        <button id="confirmExitSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="confirmExitGo" class="btn">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>
  <div id="helpOverlay" class="overlay" aria-hidden="true">
    <div class="card help-card" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <button class="x" id="helpClose" title="–ó–∞–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É">‚úï</button>

      <h3 id="helpTitle" class="help-title">–°–ü–†–ê–í–ö–ê</h3>
      <p class="help-subtitle">
        –Ω–∞–¥–µ—é—Å—å, –≤—ã –Ω–µ –∑–∞–ø—É—Ç–∞–µ—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö, –∫–∞–∫ –Ω–∞—à –∫–æ—Ç–∏–∫!
      </p>

      <div class="help-content">
        <div class="help-scroll">
          <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ -->
          <div class="help-page" data-page="1">
            <p><strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</strong></p>
            <p>–ö–ª–∞–≤–∏—à–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–π, –∏ –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ.</p>

            <p><strong>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</strong></p>
            <ul>
              <li><b>B / –ò</b> ‚Äî –∫–∏—Å—Ç—å.</li>
              <li><b>E / –£</b> ‚Äî –ª–∞—Å—Ç–∏–∫.</li>
              <li><b>P / –ó</b> ‚Äî –ø–∏–ø–µ—Ç–∫–∞ (–≤–∑—è—Ç—å —Ü–≤–µ—Ç —Å —Ö–æ–ª—Å—Ç–∞).</li>
              <li><b>–í—ã–¥–µ–ª–µ–Ω–∏–µ</b> –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ ¬´–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç¬ª.</li>
              <li><b>–õ—É–ø–∞</b> ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è.</li>
            </ul>

            <p><strong>–†–∞–∑–º–µ—Ä –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫–∏—Å—Ç–∏</strong></p>
            <ul>
              <li><b>[ / –•</b> ‚Äî —É–º–µ–Ω—å—à–∏—Ç—å —Ç–æ–ª—â–∏–Ω—É –∫–∏—Å—Ç–∏.</li>
              <li><b>] / –™</b> ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–æ–ª—â–∏–Ω—É –∫–∏—Å—Ç–∏.</li>
              <li><b>=</b> ‚Äî —Å–¥–µ–ª–∞—Ç—å –∫–∏—Å—Ç—å –±–æ–ª–µ–µ –ø–ª–æ—Ç–Ω–æ–π (—É–≤–µ–ª–∏—á–∏—Ç—å –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å).</li>
              <li><b>-</b> ‚Äî —Å–¥–µ–ª–∞—Ç—å –∫–∏—Å—Ç—å –±–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π.</li>
            </ul>

            <p><strong>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ</strong></p>
            <p>–ü–æ–ª–∑—É–Ω–æ–∫ ¬´–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ¬ª —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–ª–∞–≤–Ω–æ—Å—Ç—å—é –ª–∏–Ω–∏–π: —Å–ª–µ–≤–∞ ‚Äî –ø–æ—á—Ç–∏ –ø–∏–∫—Å–µ–ª—å–Ω–æ, —Å–ø—Ä–∞–≤–∞ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–ª–∞–≤–Ω—ã–µ –ª–∏–Ω–∏–∏.</p>
          </div>

          <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –∏—Å—Ç–æ—Ä–∏—è –∏ –±—É—Ñ–µ—Ä -->
          <div class="help-page" data-page="2">
            <p><strong>–í—ã–¥–µ–ª–µ–Ω–∏–µ</strong></p>
            <ul>
              <li>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç <b>¬´–í—ã–¥–µ–ª–µ–Ω–∏–µ¬ª</b> ‚Äî –æ–±–≤–æ–¥–∏–º –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç—É—Ä–∞–º–∏.</li>
              <li>–ü–æ—Å–ª–µ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç ¬´–æ—Ç—Ä—ã–≤–∞–µ—Ç—Å—è¬ª –æ—Ç —Å–ª–æ—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º.</li>
              <li>–î–≤–∏–≥–∞—Ç—å –∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å –µ–≥–æ –º–æ–∂–Ω–æ –∑–∞ —Ä–∞–º–∫—É –∏ –∑–∞ —á–µ—Ç—ã—Ä–µ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞ –ø–æ —É–≥–ª–∞–º.</li>
              <li><b>–ü–ö–ú</b> –≤ —Ä–µ–∂–∏–º–µ ¬´–í—ã–¥–µ–ª–µ–Ω–∏–µ¬ª ‚Äî –æ—Ç–º–µ–Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ä–∏—Å—É–Ω–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</li>
              <li>–ö–Ω–æ–ø–∫–∏ <b>‚úî</b> –∏ <b>‚úñ</b> —Å–Ω–∏–∑—É ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å / –æ—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è.</li>
            </ul>

            <p><strong>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</strong></p>
            <ul>
              <li><b>Z / –Ø</b> ‚Äî —à–∞–≥ –Ω–∞–∑–∞–¥ (Undo).</li>
              <li><b>A / –§</b> ‚Äî —à–∞–≥ –≤–ø–µ—Ä—ë–¥ (Redo).</li>
            </ul>

            <p><strong>–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (–¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è)</strong></p>
            <ul>
              <li><b>C / –°</b> ‚Äî —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å.</li>
              <li><b>V / –ú</b> ‚Äî –≤—Å—Ç–∞–≤–∏—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫—É—Ä—Å–æ—Ä.</li>
              <li>–° —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-—Å–ª–æ—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ: –µ–≥–æ –º–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å, –Ω–æ –Ω–µ–ª—å–∑—è –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–∞–¥—Ä.</li>
            </ul>
          </div>

          <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 ‚Äî –ø–∏–ø–µ—Ç–∫–∞, –∑—É–º –∏ —Ç–∞–π–º–µ—Ä -->
          <div class="help-page" data-page="3">
            <p><strong>–ü–∏–ø–µ—Ç–∫–∞</strong></p>
            <ul>
              <li><b>P / –ó</b> ‚Äî –≤–∫–ª—é—á–∏—Ç—å –ø–∏–ø–µ—Ç–∫—É.</li>
              <li>–©–µ–ª—á–æ–∫ –ø–æ —Ö–æ–ª—Å—Ç—É –≤ —Ä–µ–∂–∏–º–µ –ø–∏–ø–µ—Ç–∫–∏ ‚Äî –≤–∑—è—Ç—å —Ü–≤–µ—Ç –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º.</li>
              <li><b>B / –ò</b> ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –∫–∏—Å—Ç—å.</li>
              <li><b>Esc</b> ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –ø–∏–ø–µ—Ç–∫—É –∏ –∑–∞–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É (–µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞).</li>
            </ul>

            <p><strong>–ú–∞—Å—à—Ç–∞–± (–ª—É–ø–∞)</strong></p>
            <ul>
              <li>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç <b>¬´–õ—É–ø–∞¬ª</b> –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ ¬´–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç¬ª.</li>
              <li><b>–ö–æ–ª—ë—Å–∏–∫–æ –º—ã—à–∏</b> –≤ —Ä–µ–∂–∏–º–µ –ª—É–ø—ã ‚Äî –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å / –æ—Ç–¥–∞–ª–∏—Ç—å —Ö–æ–ª—Å—Ç.</li>
              <li><b>‚Üë</b> (—Å—Ç—Ä–µ–ª–∫–∞ –≤–≤–µ—Ä—Ö) ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å –º–∞—Å—à—Ç–∞–±.</li>
              <li><b>‚Üì</b> (—Å—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑) ‚Äî —É–º–µ–Ω—å—à–∏—Ç—å –º–∞—Å—à—Ç–∞–±.</li>
              <li>–ó–∞–∂–∞—Ç–∞—è –õ–ö–ú –≤ —Ä–µ–∂–∏–º–µ –ª—É–ø—ã ‚Äî –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (–ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞).</li>
            </ul>

            <hr>

            <p><strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</strong></p>
            <p>
              –í —Ä–µ–∂–∏–º–µ <b>—Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–µ—Ä–∏–∏</b> —Ç–∞–π–º–µ—Ä–∞ –Ω–µ—Ç ‚Äî –º–æ–∂–Ω–æ —Ä–∏—Å–æ–≤–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ
              –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.
            </p>
            <p>
              –í —Ä–µ–∂–∏–º–µ <b>–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Å–µ—Ä–∏–∏</b> (–∫–æ–≥–¥–∞ –≤—ã –ø—Ä–∏—à–ª–∏ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è) —Å–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞
              –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä:
            </p>
            <ul>
              <li>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è ‚Äî <b>10 –º–∏–Ω—É—Ç</b>.</li>
              <li>–ï—Å–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —Ç–∞–π–º–µ—Ä –±—É–¥–µ—Ç –∫–æ—Ä–æ—á–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∞—Å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞.</li>
              <li>–ö–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –Ω—É–ª—è, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ–∫–Ω–æ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∫–∞–¥—Ä.</li>
              <li>–ù–∞ —Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏; –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–∂–∞—Ç—å, –∫–∞–¥—Ä —É–¥–∞–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
            </ul>

            <p><strong>–í–æ—Ç –∏ —Ä–∞–∑–æ–±—Ä–∞–ª–∏—Å—å, –ø—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã!</strong></p>
          </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º -->
        <div class="help-pager">
          <button id="helpPrev" type="button">‚Äπ –ù–∞–∑–∞–¥</button>
          <span id="helpPageLabel">1 / 3</span>
          <button id="helpNext" type="button">–í–ø–µ—Ä—ë–¥ ‚Ä∫</button>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å –∫–æ—Ç–∞–º–∏ -->
      <div class="help-side">
        <img
          src="KOT1.PNG"
          alt="–ö–æ—Ç, –∑–∞–ø—É—Ç–∞–≤—à–∏–π—Å—è –≤ –∫–∏–Ω–æ–ª–µ–Ω—Ç–µ –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö"
          id="helpCatPrimary"
          class="help-cat"
        />
        <img
          src="KOT2.PNG"
          alt="–ö–æ—Ç, –∑–∞–ø—É—Ç–∞–≤—à–∏–π—Å—è –µ—â—ë —Å–∏–ª—å–Ω–µ–µ, –Ω–æ –¥–æ–≤–æ–ª—å–Ω—ã–π"
          id="helpCatSecondary"
          class="help-cat-secondary"
        />
      </div>

    </div>
  </div>




  <script>
  (function () {
    'use strict';

    // === –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã ===
    let saving = false;
    function setSaving(state) {
      saving = !!state;
      const topBtn = document.getElementById('saveDrawBtn');
      const doBtn = document.getElementById('doSave');
      [topBtn, doBtn].forEach((btn) => {
        if (!btn) return;
        btn.disabled = saving;
        btn.style.opacity = saving ? '0.6' : '';
        if (saving) {
          if (btn === topBtn) btn.dataset._prev = btn.textContent, btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
          if (btn === doBtn) btn.dataset._prev = btn.textContent, btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
        } else if (btn.dataset._prev) {
          btn.textContent = btn.dataset._prev;
          delete btn.dataset._prev;
        }
      });
    }

    const params = new URLSearchParams(location.search);
    const mode = (params.get('mode') || '').toLowerCase();
    const seriesId = Number(params.get('series')) || null;

    const SUPABASE_URL = 'https://upanhirmxhfzpajvswoq.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwYW5oaXJteGhmenBhanZzd29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjIwNzcsImV4cCI6MjA3MjIzODA3N30.HhrccU3DfoLadflBmTxIDXJgrDQB3m2zLRX3vtRycGA';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { autoRefreshToken: false, persistSession: false, detectSessionInUrl: false },
    });
  
async function checkSiteOpen() {
  try {
    const { data, error } = await supabase
      .from('site_state')
      .select('is_open, announcement')
      .limit(1)
      .single();
    if (error) {
      console.warn('site_state load error', error);
      return;
    }
    const open = data && data.is_open !== false;

    // –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–∞–π—Ç –∑–∞–∫—Ä—ã—Ç –¥–ª—è –≥–æ—Å—Ç–µ–π
    let adminBypass = false;
    try {
      if (!open && typeof window.isAdmin === 'function') {
        adminBypass = await window.isAdmin();
      }
    } catch (e) {
      console.warn('isAdmin check in checkSiteOpen failed', e);
    }

    const overlay = document.getElementById('site-closed-overlay');
    const messageEl = document.getElementById('site-closed-message');

    if (!open && !adminBypass) {
      if (overlay) {
        if (messageEl) {
          messageEl.textContent =
            (data && data.announcement) ||
            '–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.';
        }
        overlay.style.display = 'flex';
        document.body.classList.add('site-closed');
      }
    } else {
      // –°–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –∏–ª–∏ –∞–¥–º–∏–Ω –≤–æ—à—ë–ª ‚Äî —É–±–∏—Ä–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      if (overlay) {
        overlay.style.display = 'none';
        document.body.classList.remove('site-closed');
      }
    }
  } catch (e) {
    console.warn('checkSiteOpen failed', e);
  }
}
checkSiteOpen();

// –ï—Å–ª–∏ –∞–¥–º–∏–Ω –∑–∞–ª–æ–≥–∏–Ω–∏–ª—Å—è —É–∂–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —Å–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
window.addEventListener('admin:enabled', function () {
  var overlay = document.getElementById('site-closed-overlay');
  if (overlay) {
    overlay.style.display = 'none';
    document.body.classList.remove('site-closed');
  }
});
// –ö–ª—é—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å vote.html)
    const K_STATE = (id) => `kadry_vote_state_${id}`;
    const K_ROUND = (id) => `kadry_round_at_${id}`;
    const K_END = (id) => `kadry_end_at_${id}`;

    const MAX_DRAW_MS = 10 * 60 * 1000;
    const SAVE_BUFFER_MS = 60 * 1000;
    const NET_RESERVE_MS = 30 * 1000;

    function postSync(seriesId, msg) {
      try {
        msg.seriesId = String(seriesId);
      } catch (_) {}
      try {
        msg.ts = Date.now();
      } catch (_) {}

      try {
        const bc = new BroadcastChannel('kadry_vote');
        bc.postMessage(msg);
        bc.close();
      } catch (_) {}

      try {
        localStorage.setItem('kadry_broadcast', JSON.stringify({ ...msg, ts: Date.now() }));
      } catch (_) {
        localStorage.setItem('kadry_broadcast', String(Date.now()));
      }
    }

    function readStateAndEnd() {
      let state = 'active';
      let endMs = 0;
      try {
        if (seriesId) {
          state =
            localStorage.getItem(K_STATE(seriesId)) ||
            localStorage.getItem(`series_${seriesId}_state`) ||
            'active';
          endMs =
            Number(localStorage.getItem(K_END(seriesId))) ||
            Number(localStorage.getItem(`series_${seriesId}_round_end_at`)) ||
            0;
        }
      } catch (_) {}
      return { state, endMs };
    }

    const linkSeries = document.getElementById('backSeries');
    const timerContainer = document.getElementById('timerContainer');

    let unsaved = false;
    function setHeaderForMode() {
      if (mode === 'new') {
        if (linkSeries) linkSeries.style.display = 'none';
        if (timerContainer) timerContainer.style.display = 'none';
      } else {
        if (linkSeries) {
          linkSeries.style.display = 'inline';
          if (seriesId) linkSeries.href = 'series.html?id=' + seriesId;
        }
        if (timerContainer) timerContainer.style.display = 'block';
      }
    }
    function confirmLeave(e) {
      if (mode === 'new' && unsaved) {
        const msg = '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–∞—à —Ä–∏—Å—É–Ω–æ–∫ –±—É–¥–µ—Ç —É—Ç–µ—Ä—è–Ω!';
        e.preventDefault();
        e.returnValue = msg;
        return msg;
      }
    }
    function hookHeaderLinks() {
      function guard(el) {
        if (!el) return;
        el.addEventListener('click', function (e) {
          if (mode === 'new' && unsaved) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–∞—à —Ä–∏—Å—É–Ω–æ–∫ –±—É–¥–µ—Ç —É—Ç–µ—Ä—è–Ω!')) e.preventDefault();
          }
        });
      }
      guard(linkSeries);
      window.addEventListener('beforeunload', confirmLeave);
    }

    function exportPNG() {
      const wrap = document.getElementById('canvasWrap');
      if (!wrap) return null;
      let canvases = Array.from(wrap.querySelectorAll('canvas'));
      if (document.body.classList.contains('modal-open') && canvases.length > 1) {
        canvases = canvases.slice(0, -1);
      }
      if (!canvases.length) return null;
      const W = canvases[0].width || 1920;
      const H = canvases[0].height || 1080;
      const out = document.createElement('canvas');
      out.width = W;
      out.height = H;
      const ctx = out.getContext('2d');
      canvases.forEach((cv) => {
        try {
          ctx.drawImage(cv, 0, 0);
        } catch (_) {}
      });
      return out;
    }

    const overlay = document.getElementById('saveOverlay');
    const btnOpenOverlay = document.getElementById('saveDrawBtn');
    const btnCloseOverlay = document.getElementById('saveClose');
    const btnDoSave = document.getElementById('doSave');
    const inpTitle = document.getElementById('seriesTitle');
    const inpDesc = document.getElementById('seriesDesc');
        // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø—Ä–∞–≤–∫–∏
    const helpOverlay = document.getElementById('helpOverlay');
    const helpBtn = document.getElementById('helpBtn');
    const helpClose = document.getElementById('helpClose');
        // –°—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø—Ä–∞–≤–∫–∏
    let resetHelpPages = null;

    function initHelpPaging() {
      if (!helpOverlay) return;

      const pages = Array.from(helpOverlay.querySelectorAll('.help-page'));
      if (!pages.length) return;

      const prevBtn = document.getElementById('helpPrev');
      const nextBtn = document.getElementById('helpNext');
      const pageLabel = document.getElementById('helpPageLabel');
      const scrollBox = helpOverlay.querySelector('.help-scroll');
      let current = 0;

      function clampIndex(v) {
        return Math.max(0, Math.min(pages.length - 1, v));
      }

     function apply(index) {
  current = clampIndex(index);
  pages.forEach((el, i) => {
    el.classList.toggle('active', i === current);
  });

  if (pageLabel) {
    pageLabel.textContent = (current + 1) + ' / ' + pages.length;
  }
  if (prevBtn) prevBtn.disabled = current === 0;
  if (nextBtn) nextBtn.disabled = current === pages.length - 1;
  if (scrollBox) scrollBox.scrollTop = 0;

  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—Ç–∏–∫–æ–≤
  try {
    const cat1 = document.getElementById('helpCatPrimary');
    const cat2 = document.getElementById('helpCatSecondary');
    if (cat1 && cat2) {
      if (current === 0) {
        // –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: —Ç–æ–ª—å–∫–æ KOT1
        cat1.style.display = 'block';
        cat2.style.display = 'none';
      } else if (current === pages.length - 1) {
        // –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: —Ç–æ–ª—å–∫–æ KOT2
        cat1.style.display = 'none';
        cat2.style.display = 'block';
      } else {
        // –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –±–µ–∑ –∫–æ—Ç–∏–∫–æ–≤
        cat1.style.display = 'none';
        cat2.style.display = 'none';
      }
    }
  } catch (e) {
    console.warn('help cats toggle failed', e);
  }
}


      if (prevBtn) {
        prevBtn.addEventListener('click', function () {
          apply(current - 1);
        });
      }
      if (nextBtn) {
        nextBtn.addEventListener('click', function () {
          apply(current + 1);
        });
      }

      // —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã–∑–æ–≤–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–ø—Ä–∞–≤–∫–∏
      resetHelpPages = function () {
        apply(0);
      };

      // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      apply(0);
    }



      function showOverlay(el) {
      el.classList.add('show');
      el.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');

      // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ —Å–ø—Ä–∞–≤–∫—É ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      if (el === helpOverlay && typeof resetHelpPages === 'function') {
        resetHelpPages();
      }
    }

    function hideOverlay(el) {
      el.classList.remove('show');
      el.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
    }

    btnOpenOverlay.addEventListener('click', function (e) {
      if (saving) return;
      if (mode === 'new') {
        e.preventDefault();
        showOverlay(overlay);
      } else {
        e.preventDefault();
        if (!seriesId) return;
        openDecisionFromManual();
      }
    });
    btnCloseOverlay.addEventListener('click', function () {
      hideOverlay(overlay);
    });

    async function saveNewSeries() {
      if (saving) return;
      setSaving(true);
      try {
        const exporter =
          window.drawAPI && typeof window.drawAPI.exportCompositeBlob === 'function'
            ? window.drawAPI.exportCompositeBlob
            : null;
        if (!exporter && !document.getElementById('canvasWrap')) {
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ö–æ–ª—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          return;
        }
        const rawTitle = (inpTitle.value || '').trim();
if (!rawTitle) {
  alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏');
  inpTitle.focus();
  return;
}
if (rawTitle.length > 20) {
  alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤). –°–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ.');
  inpTitle.focus();
  return;
}
const title = rawTitle;
const desc = (inpDesc.value || '').trim();


        const blob = exporter
          ? await exporter()
          : await new Promise((r) => exportPNG().toBlob(r, 'image/png'));
        if (!blob || !blob.size) {
          alert('–ü—É—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç ‚Äî –Ω–∞ —Ö–æ–ª—Å—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        const file = new File([blob], 'first.png', { type: 'image/png' });
        const rand = Math.random().toString(36).slice(2, 8);
        let fileName = `first/${Date.now()}_${rand}.png`;

        let up = await supabase.storage
          .from('Frames')
          .upload(fileName, file, { contentType: 'image/png', cacheControl: '3600', upsert: false });
        if (up.error) {
          const alt = `${Date.now()}_${rand}_${Math.floor(performance.now())}.png`;
          let up2 = await supabase.storage
            .from('Frames')
            .upload(alt, file, { contentType: 'image/png', cacheControl: '3600', upsert: true });
          if (up2.error) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
          }
          fileName = alt;
        }

        const { data: publicUrlData } = supabase.storage.from('Frames').getPublicUrl(fileName);
        const imageUrl = (publicUrlData && (publicUrlData.publicUrl || publicUrlData.publicURL)) || null;
        if (!imageUrl) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          return;
        }


        const payload = desc ? { title, description: desc } : { title };

        const ins = await supabase.from('series').insert([payload]).select('id').single();
        if (ins.error || !ins.data) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–∏—é');
          return;
        }
        const newSeriesId = ins.data.id;

        const { error: fErr } = await supabase.from('frames').insert([
          {
            series_id: newSeriesId,
            image_url: imageUrl,
            committed: true,
            in_vote: false,
            history: false,
            order_index: 1,
          },
        ]);
        if (fErr) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä');
          return;
        }

        unsaved = false;
        location.replace('series.html?id=' + newSeriesId);
      } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä–∏–∏');
      } finally {
        setSaving(false);
        hideOverlay(overlay);
      }
    }
    btnDoSave.addEventListener('click', saveNewSeries);
        // –û—Ç–∫—Ä—ã—Ç–∏–µ / –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–ø—Ä–∞–≤–∫–∏
    if (helpBtn && helpOverlay) {
      helpBtn.addEventListener('click', function () {
        showOverlay(helpOverlay);
      });
    }

    if (helpClose && helpOverlay) {
      helpClose.addEventListener('click', function () {
        hideOverlay(helpOverlay);
      });
    }


    async function getNextOrderIndex(seriesId) {
      try {
        const r = await supabase
          .from('frames')
          .select('order_index')
          .eq('series_id', seriesId)
          .eq('committed', true)
          .order('order_index', { ascending: false })
          .limit(1);
        if (r.error) throw r.error;
        const max =
          (r.data && r.data[0] && (r.data[0].order_index || 0)) ||
          0;
        const n = typeof max === 'number' && isFinite(max) ? max : parseInt(max, 10) || 0;
        return n + 1;
      } catch (e) {
        console.warn('getNextOrderIndex error', e);
        return 1;
      }
    }

    window.saveFrameToSeries = async function (seriesId, supabase) {
      if (saving) return;
      setSaving(true);
      try {
        const exporter =
          window.drawAPI && typeof window.drawAPI.exportCompositeBlob === 'function'
            ? window.drawAPI.exportCompositeBlob
            : null;
        if (!exporter && !document.getElementById('canvasWrap')) {
          alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ö–æ–ª—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          return;
        }
        const blob = exporter
          ? await exporter()
          : await new Promise((r) => exportPNG().toBlob(r, 'image/png'));
        if (!blob || !blob.size) {
          alert('–ü—É—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç ‚Äî –Ω–∞ —Ö–æ–ª—Å—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
          return;
        }
        const file = new File([blob], 'candidate.png', { type: 'image/png' });

        const rand = Math.random().toString(36).slice(2, 8);
        let fileName = `candidates/${Date.now()}_${rand}.png`;
        let up = await supabase.storage
          .from('Frames')
          .upload(fileName, file, { contentType: 'image/png', cacheControl: '3600', upsert: false });
        if (up.error) {
          const alt = `${Date.now()}_${rand}_${Math.floor(performance.now())}.png`;
          let up2 = await supabase.storage
            .from('Frames')
            .upload(alt, file, { contentType: 'image/png', cacheControl: '3600', upsert: true });
          if (up2.error) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
          }
          fileName = alt;
        }
        const { data: pub } = supabase.storage.from('Frames').getPublicUrl(fileName);
        const imageUrl = (pub && (pub.publicUrl || pub.publicURL)) || null;
        if (!imageUrl) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          return;
        }

        const nextOrder = await getNextOrderIndex(seriesId);

        let exCount = 0;
        try {
          const c = await supabase
            .from('frames')
            .select('id', { count: 'exact', head: true })
            .eq('series_id', seriesId)
            .eq('in_vote', true)
            .eq('order_index', nextOrder);
          exCount = c.count || 0;
        } catch (_) {
          exCount = 0;
        }
        const isFirstInRound = exCount === 0;

       let insertedId = null;
let insErr = null;
try {
  const ins = await supabase
    .from('frames')
    .insert([
      {
        series_id: seriesId,
        image_url: imageUrl,
        committed: false,
        in_vote: true,
        history: false,
        order_index: nextOrder,
      },
    ])
    .select('id')
    .single();
  if (ins.error) insErr = ins.error;
  else insertedId = ins.data?.id || null;
} catch (e) {
  insErr = e;
}

// üî• –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º —Ä–∞—É–Ω–¥ –≤ SQL
let rpcOk = false;
let fnError = null;

try {
  const rpcRes = await supabase.rpc(
    'voting_extend_round',
    { p_series_id: seriesId }
  );

  fnError = rpcRes.error;

  if (fnError) {
    console.error('RPC voting_extend_round error:', fnError);
  } else {
    rpcOk = true;
  }

} catch (e) {
  console.error('RPC voting_extend_round failed:', e);
  fnError = e;
}

// üîî –°–æ–æ–±—â–∞–µ–º –≤–∫–ª–∞–¥–∫–∞–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, —á—Ç–æ —Ä–∞—É–Ω–¥ –æ–±–Ω–æ–≤–ª—ë–Ω
try {
  const bc = new BroadcastChannel("kadry_vote");
  bc.postMessage({
    type: "round_updated",
    seriesId: String(seriesId),
    ok: rpcOk,
    ts: Date.now()
  });
  bc.close();
} catch (e) {
  console.warn("broadcast failed", e);
}

// –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî —É–≤–µ–¥–æ–º–∏–º –∞–¥–º–∏–Ω–∞
if (fnError) {
  alert(
    '–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Ä–∞—É–Ω–¥–∞: ' +
      (fnError.message || fnError.code || '—Å–º. –∫–æ–Ω—Å–æ–ª—å')
  );
}



if (insErr) {
          const probe = await supabase
            .from('frames')
            .select('id')
            .eq('series_id', seriesId)
            .eq('order_index', nextOrder)
            .eq('image_url', imageUrl)
            .eq('in_vote', true)
            .order('id', { ascending: false })
            .limit(1)
            .maybeSingle();
          if (probe?.data?.id) insertedId = probe.data.id;
          else {
            console.warn('insert error', insErr);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–¥—Ä');
            return;
          }
        }

        const evt = isFirstInRound
          ? { type: 'unfreeze', round: { startAt: new Date().toISOString() } }
          : { type: 'new_frame', firstInRound: false };

        try {
          sessionStorage.setItem(
            'kadry_pending_event_' + String(seriesId),
            JSON.stringify({ ...evt, seriesId: String(seriesId) })
          );
        } catch (_) {}

        postSync(seriesId, evt);

        await new Promise((r) => setTimeout(r, 150));
        await new Promise(r => setTimeout(r, 150));
location.replace('vote.html?series=' + seriesId);

      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–¥—Ä–∞');
      } finally {
        setSaving(false);
      }
    };

    async function initEditor() {
      if (typeof window.initDrawEditor !== 'function') {
        console.error('initDrawEditor –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—å –∑–∞–≥—Ä—É–∑–∫—É draw.js');
        return;
      }
      const cfg = { supabase };
      if (seriesId) cfg.seriesId = seriesId;
      if (seriesId && mode !== 'new') {
        try {
          const { data, error } = await supabase
            .from('frames')
            .select('image_url')
            .eq('series_id', seriesId)
            .eq('committed', true)
            .order('order_index', { ascending: false })
            .limit(1);
          if (!error && data?.length && data[0]?.image_url) cfg.baseImageUrl = data[0].image_url;
        } catch (e) {
          console.warn('load base frame error', e);
        }
      }
      window.initDrawEditor(cfg);
    }

    function fitCanvasWrap() {
      const holder = document.querySelector('.canvas-holder');
      const wrapEl = document.getElementById('canvasWrap');
      if (!holder || !wrapEl) return;
      const r = holder.getBoundingClientRect();
      const availW = r.width;
      const availH = r.height;
      const targetW = Math.min(availW, (availH * 16) / 9);
      const targetH = (targetW * 9) / 16;
      wrapEl.style.width = targetW + 'px';
      wrapEl.style.height = targetH + 'px';
    }
    window.addEventListener('resize', fitCanvasWrap);

    function markUnsaved() {
      if (mode === 'new') unsaved = true;
    }
    document.addEventListener('pointerdown', markUnsaved, { passive: true });
    document.addEventListener('keydown', function (e) {
      const t = e.target;
      const tag = (t && t.tagName) || '';
      const lower = tag.toLowerCase();
      if (lower !== 'input' && lower !== 'textarea') markUnsaved();
    });

    let drawDeadline = null;
    let drawTimerId = null;
    let drawExpired = false;

    let decisionOverlay = null;
    let decisionTimerId = null;

    function formatMMSS(ms) {
      const s = Math.max(0, Math.ceil(ms / 1000));
      const m = Math.floor(s / 60);
      const ss = String(s % 60).padStart(2, '0');
      return `${m}:${ss}`;
    }

    function setTimerClass(el, remMs) {
      if (!el) return;
      el.classList.remove('warn', 'danger');
      if (remMs <= 60 * 1000) el.classList.add('danger');
      else if (remMs <= 3 * 60 * 1000) el.classList.add('warn');
    }

    function startDrawTimer(customDeadlineMs) {
      if (!seriesId || mode === 'new') return;

      const { state, endMs } = readStateAndEnd();
      const now = Date.now();

      if (typeof customDeadlineMs === 'number') {
        drawDeadline = customDeadlineMs;
      } else if (state === 'winner_frozen' || state === 'replay_frozen') {
        drawDeadline = now + MAX_DRAW_MS;
      } else {
        if (!endMs) {
          drawDeadline = now + MAX_DRAW_MS;
        } else {
          const remain = endMs - now;
          if (remain <= SAVE_BUFFER_MS) {
            alert(
              '–î–æ –∫–æ–Ω—Ü–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏. –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –Ω–µ–ª—å–∑—è.'
            );
            location.replace('series.html?id=' + seriesId);
            return;
          }
          const allowed = Math.min(MAX_DRAW_MS, remain - SAVE_BUFFER_MS);
          drawDeadline = now + allowed;
        }
      }

      drawExpired = false;

      let badge = document.getElementById('timerBadge');
      if (!badge) {
        badge = document.createElement('span');
        badge.id = 'timerBadge';
        badge.className = 'timer-badge';
        timerContainer.innerHTML = '';
        timerContainer.appendChild(badge);
      }

      if (drawTimerId) clearInterval(drawTimerId);

      function tick() {
        const now = Date.now();
        let rem = drawDeadline - now;
        if (rem <= 0) {
          rem = 0;
          badge.textContent = '0:00';
          setTimerClass(badge, 0);
          clearInterval(drawTimerId);
          drawTimerId = null;
          if (!drawExpired) {
            drawExpired = true;
            lockDrawingAndOpenDecision();
          }
          return;
        }
        badge.textContent = formatMMSS(rem);
        setTimerClass(badge, rem);
      }

      tick();
      drawTimerId = setInterval(tick, 250);
    }

    function lockDrawingAndOpenDecision() {
      document.body.classList.add('time-expired');
      openDecisionModal('auto');
      startDecisionTimer();
    }

    function openDecisionFromManual() {
      openDecisionModal('manual');
      startDecisionTimer();
    }

    function openDecisionModal(modeKind) {
      const kind = modeKind || 'manual';
      if (!decisionOverlay) {
        decisionOverlay = document.createElement('div');
        decisionOverlay.className = 'overlay';
        decisionOverlay.innerHTML = `
          <div class="card">
            <h3>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∏—Å—É–Ω–∫–∞</h3>
            <p id="decMain"></p>
            <div class="actions">
              <button id="decSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="decContinue" class="btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∏—Å–æ–≤–∞—Ç—å</button>
            </div>
          </div>`;
        document.body.appendChild(decisionOverlay);

        const saveBtn = decisionOverlay.querySelector('#decSave');
        const contBtn = decisionOverlay.querySelector('#decContinue');

        saveBtn.onclick = function () {
          if (typeof window.saveFrameToSeries === 'function') {
            window.saveFrameToSeries(seriesId, supabase);
          }
        };

        contBtn.onclick = function () {
          if (drawExpired) {
            showAutoDelete();
          } else {
            closeDecisionModal();
          }
        };
      }

      const contBtn = decisionOverlay.querySelector('#decContinue');
      if (contBtn) {
        contBtn.textContent = drawExpired ? '–£–¥–∞–ª–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫' : '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∏—Å–æ–≤–∞—Ç—å';
      }
      decisionOverlay.dataset.mode = kind;
      decisionOverlay.classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeDecisionModal() {
      if (decisionOverlay) decisionOverlay.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    function startDecisionTimer() {
      const main = document.getElementById('decMain');
      if (!main) return;

      if (decisionTimerId) clearInterval(decisionTimerId);

      function tick() {
        const { state, endMs } = readStateAndEnd();
        const now = Date.now();

        if (state === 'winner_frozen' || state === 'replay_frozen' || !endMs) {
          main.textContent =
            '–°–µ–π—á–∞—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–∞—É–∑–µ. –í—ã –º–æ–∂–µ—Ç–µ –Ω–µ —Å–ø–µ—à–∏—Ç—å —Å —Ä–µ—à–µ–Ω–∏–µ–º ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–∫–∞ –Ω–µ—Ç.';
          return;
        }

        const decisionDeadline = endMs - NET_RESERVE_MS;
        const remain = decisionDeadline - now;

        if (remain <= 0) {
          clearInterval(decisionTimerId);
          decisionTimerId = null;
          showAutoDelete();
          return;
        }

        main.textContent =
          '–ù–∞ —Ä–µ—à–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å: ' + formatMMSS(remain) + '.';
      }

      tick();
      decisionTimerId = setInterval(tick, 500);
    }

    function showAutoDelete() {
      closeDecisionModal();
      if (decisionTimerId) {
        clearInterval(decisionTimerId);
        decisionTimerId = null;
      }
      if (drawTimerId) {
        clearInterval(drawTimerId);
        drawTimerId = null;
      }

      document.body.classList.add('time-expired');

      const auto = document.createElement('div');
      auto.className = 'overlay show';
      auto.innerHTML = `
        <div class="card">
          <h3>–ù—É –≤–æ—Ç‚Ä¶</h3>
          <p>–í–∞—à —Ä–∏—Å—É–Ω–æ–∫ —É–¥–∞–ª–∏–ª—Å—è :(</p>
          <div class="actions">
            <button id="autoOk" class="btn primary">–õ–∞–¥–Ω–æ‚Ä¶</button>
          </div>
        </div>`;
      document.body.appendChild(auto);

      auto.querySelector('#autoOk').onclick = function () {
        location.replace('index.html');
      };
    }
       // === –ü–ò–ü–ï–¢–ö–ê =====================================================
    let eyedropperActive = false;
    let toolSelectEl = null; // —Å–µ–ª–µ–∫—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

 function setEyedropperActive(on) {
  eyedropperActive = !!on;
  window.__kadryEyedropperOn = eyedropperActive;
  document.body.classList.toggle('eyedropper-active', eyedropperActive);

  // 1) –≥–∞—Å–∏–º –Ω–∞—à —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø—Ä–µ–≤—å—é-–∫—Ä—É–∂–æ–∫
  try {
    const preview = document.getElementById('colorPreview');
    if (preview) preview.style.opacity = '0';

    if (window.drawAPI && typeof window.drawAPI.setBrushCursorVisible === 'function') {
      window.drawAPI.setBrushCursorVisible(!eyedropperActive);
    }
  } catch (e) {}

  // 2) –ì–†–£–ë–´–ô –•–ê–ö: –∏—â–µ–º –≤—Å–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –∫—Ä—É–≥–ª—ã–µ div'—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  //    –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä—è—á–µ–º –∏—Ö –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø–∏–ø–µ—Ç–∫–∏.
  try {
    const divs = Array.from(document.querySelectorAll('div'));

    divs.forEach((el) => {
      // colorPreview –º—ã —É–∂–µ –ø–æ—Ç—É—à–∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
      if (el.id === 'colorPreview') return;

      const rect = el.getBoundingClientRect();
      if (!rect.width || !rect.height) return;

      // –æ—Ç—Å–µ–∫–∞–µ–º –±–æ–ª—å—à–∏–µ –±–ª–æ–∫–∏ ‚Äî –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –º–µ–ª–∫–∏–µ –∫—Ä—É–∂–æ—á–∫–∏
      if (rect.width > 120 || rect.height > 120) return;

      const cs = getComputedStyle(el);
      const br = cs.borderRadius || '';
      const bw = parseFloat(cs.borderWidth || '0');

      if (!br || bw === 0) return; // –±–µ–∑ —Ä–∞–º–∫–∏ –∏ —Ä–∞–¥–∏—É—Å–∞ –Ω–∞–º –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ

      const sizeMin = Math.min(rect.width, rect.height);
      const numericBR = parseFloat(br) || 0;

      // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∫—Ä—É–≥
      const isCircle =
        br.includes('%') ||
        numericBR >= sizeMin / 2 - 2;

      if (!isCircle) return;

      // —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç–∏–µ/–≤–æ–∑–≤—Ä–∞—Ç
      if (eyedropperActive) {
        if (!el.dataset._prevCursorVis) {
          el.dataset._prevCursorVis = el.style.visibility || '';
        }
        el.style.visibility = 'hidden';
      } else if ('_prevCursorVis' in el.dataset) {
        el.style.visibility = el.dataset._prevCursorVis;
        delete el.dataset._prevCursorVis;
      }
    });
  } catch (e) {
    console.warn('hide brush-like cursors failed', e);
  }

  // 3) —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
  if (toolSelectEl) {
    if (eyedropperActive) {
      // –≤–∫–ª—é—á–∏–ª–∏ –ø–∏–ø–µ—Ç–∫—É –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
      toolSelectEl.value = 'eyedropper';
    } else if (toolSelectEl.value === 'eyedropper') {
      // –≤—ã—Ö–æ–¥–∏–º –∏–∑ –ø–∏–ø–µ—Ç–∫–∏ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –∫–∏—Å—Ç—å
      toolSelectEl.value = 'brush';
      toolSelectEl.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }
}





    function applyPickedColor(hex) {
      try {
        const hidden = document.getElementById('brushColor');
        if (hidden) {
          hidden.value = hex;
          hidden.dispatchEvent(new Event('change', { bubbles: true }));
        }
        if (window.drawAPI && typeof window.drawAPI.setBrushColorFromHex === 'function') {
          window.drawAPI.setBrushColorFromHex(hex);
        }

        // —Å—Ä–∞–∑—É –∫–ª–∞–¥—ë–º —Ü–≤–µ—Ç –∏–∑ –ø–∏–ø–µ—Ç–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
        pushEyedroppedColorToHistory(hex);
      } catch (e) {
        console.warn('eyedropper apply color failed', e);
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–∏–ø–µ—Ç–∫–æ–π —Ü–≤–µ—Ç –≤ –±–ª–æ–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
    function pushEyedroppedColorToHistory(hex) {
      try {
        const swatches = Array.from(document.querySelectorAll('.color-history-swatch'));
        if (!swatches.length) return;

        let norm = (hex || '').toLowerCase();
        if (!norm) return;
        if (!norm.startsWith('#')) norm = '#' + norm;
        // –ø—Ä–æ—Å—Ç–æ–π —á–µ–∫, —á—Ç–æ–±—ã –Ω–µ –ø–∏—Ö–∞—Ç—å –º—É—Å–æ—Ä
        if (!/^#[0-9a-f]{6}$/.test(norm)) return;

        // —Ç–µ–∫—É—â–∏–µ —Ü–≤–µ—Ç–∞ –∏–∑ data-color
        const existing = swatches
          .map(btn => (btn.dataset.color || '').toLowerCase())
          .filter(Boolean);

        // –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫: –Ω–æ–≤—ã–π —Ü–≤–µ—Ç + –ø—Ä–µ–¥—ã–¥—É—â–∏–µ, –±–µ–∑ –¥—É–±–ª–µ–π
        const ordered = [norm, ...existing.filter(c => c && c !== norm)]
          .slice(0, swatches.length);

        ordered.forEach((c, idx) => {
          const btn = swatches[idx];
          if (!btn) return;
          btn.dataset.color = c;
          btn.style.background = c;
        });
      } catch (e) {
        console.warn('pushEyedroppedColorToHistory failed', e);
      }
    }


    function pickColorAtPoint(clientX, clientY) {
      const wrap = document.getElementById('canvasWrap');
      if (!wrap) return;

      const cv =
        wrap.querySelector('canvas:last-of-type') ||
        wrap.querySelector('canvas');
      if (!cv) return;

      const rect = cv.getBoundingClientRect();
      const x = Math.floor((clientX - rect.left) * cv.width / rect.width);
      const y = Math.floor((clientY - rect.top) * cv.height / rect.height);
      if (x < 0 || y < 0 || x >= cv.width || y >= cv.height) return;

      const ctx = cv.getContext('2d');
      let data;
      try {
        data = ctx.getImageData(x, y, 1, 1).data;
      } catch (e) {
        console.warn('getImageData failed', e);
        return;
      }

      const r = data[0], g = data[1], b = data[2], a = data[3] / 255;
      if (a === 0) {
        // –ø–∏–∫—Å–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        return;
      }

      const hex =
        '#' +
        [r, g, b]
          .map(v => v.toString(16).padStart(2, '0'))
          .join('');
      applyPickedColor(hex);
    }

    const adminBadge = document.getElementById('adminBadge');
    const admin10sBtn = document.getElementById('admin10sBtn');
    let adminFlag = false;

    function applyAdminUI() {
      if (!adminBadge || !admin10sBtn) return;
      if (adminFlag) {
        // –ê–¥–º–∏–Ω—Å–∫–∏–π –±–µ–π–¥–∂ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω.
        adminBadge.style.display = 'inline-flex';
        // –ö–Ω–æ–ø–∫–∞ "10s" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ —Å–µ—Ä–∏–∏,
        // —Ç–æ –µ—Å—Ç—å –∫–æ–≥–¥–∞ –º—ã —É–∂–µ –∑–Ω–∞–µ–º seriesId (—Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è).
        const showBtn = !!seriesId;
        admin10sBtn.style.display = showBtn ? 'inline-flex' : 'none';
      } else {
        adminBadge.style.display = 'none';
        admin10sBtn.style.display = 'none';
      }
    }

    function refreshAdminFromGlobal() {
      try {
        // –û–ø–∏—Ä–∞–µ–º—Å—è –Ω–∞ –∫–ª–∞—Å—Å is-admin –Ω–∞ <html>, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç admin.js.
        // –≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è UI (–∞ –¥–æ—Å—Ç—É–ø –∫ –æ–ø–µ—Ä–∞—Ü–∏—è–º –≤—Å—ë —Ä–∞–≤–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç RLS).
        adminFlag = document.documentElement.classList.contains('is-admin');
      } catch (_) {
        adminFlag = false;
      }
      applyAdminUI();
    }

    if (admin10sBtn) {
      admin10sBtn.addEventListener('click', function () {
        if (!adminFlag) return;
        const now = Date.now();
        startDrawTimer(now + 10 * 1000);
      });
    }

    // –†–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Å–æ–±—ã—Ç–∏—è admin.js
    window.addEventListener('admin:enabled', function () {
      adminFlag = true;
      applyAdminUI();
    });
    window.addEventListener('admin:disabled', function () {
      adminFlag = false;
      applyAdminUI();
    });

    function startAll() {
      setHeaderForMode();
      hookHeaderLinks();
      initEditor();
      fitCanvasWrap();
      requestAnimationFrame(fitCanvasWrap);
      refreshAdminFromGlobal();
      if (mode !== 'new' && seriesId) startDrawTimer();
      if (typeof window.maybeShowIntroModal === 'function') {
        try {
          window.maybeShowIntroModal();
        } catch (_) {}
      }

          // --- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–ø–µ—Ç–∫–∏ ---
      const eyedropBtn = document.getElementById('eyedropperBtn');
      const canvasWrap = document.getElementById('canvasWrap');
      toolSelectEl = document.getElementById('toolSel');

      // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–ª–µ –ø–∞–ª–∏—Ç—Ä—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
      if (eyedropBtn) {
        eyedropBtn.addEventListener('click', function () {
          if (eyedropperActive) {
            setEyedropperActive(false);
          } else {
            setEyedropperActive(true);
          }
        });
      }

      // –ï—Å–ª–∏ –≤ —Å–µ–ª–µ–∫—Ç–µ –≤—ã–±–∏—Ä–∞—é—Ç "–ü–∏–ø–µ—Ç–∫–∞" ‚Äî –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º, –∏–Ω–∞—á–µ –≤—ã–∫–ª—é—á–∞–µ–º
      if (toolSelectEl) {
        toolSelectEl.addEventListener('change', function () {
          if (toolSelectEl.value === 'eyedropper') {
            setEyedropperActive(true);
          } else {
            setEyedropperActive(false);
          }
        });
      }

      // –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –∫–ª–∏–∫–æ–º –ø–æ —Ö–æ–ª—Å—Ç—É
      if (canvasWrap) {
        canvasWrap.addEventListener('pointerdown', function (e) {
          if (!eyedropperActive) return;
          // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –ø–∏–ø–µ—Ç–∫–æ–π
          e.preventDefault();
          e.stopPropagation();
          pickColorAtPoint(e.clientX, e.clientY);
        }, true); // –≤–∞–∂–µ–Ω —Ç—Ä–µ—Ç–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç: —Å–ª—É—à–∞–µ–º –≤ capture-—Ñ–∞–∑–µ
      }

      // –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:
      // P / –ó ‚Äî –≤–∫–ª—é—á–∏—Ç—å –ø–∏–ø–µ—Ç–∫—É
      // B / –ò ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –∫–∏—Å—Ç—å
      // Esc ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –ø–∏–ø–µ—Ç–∫—É –∏ –∑–∞–∫—Ä—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞ —Å–ø—Ä–∞–≤–∫–∏
      document.addEventListener('keydown', function (e) {
        const key = e.key;
        const t = e.target;
        const tag = t && t.tagName ? t.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea') return;

        if (key === 'p' || key === 'P' || key === '–∑' || key === '–ó') {
          setEyedropperActive(true);
        } else if (key === 'b' || key === 'B' || key === '–∏' || key === '–ò') {
          if (toolSelectEl) {
            toolSelectEl.value = 'brush';
            toolSelectEl.dispatchEvent(new Event('change', { bubbles: true }));
          }
          setEyedropperActive(false);
        } else if (key === 'Escape') {
          // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
          if (helpOverlay && helpOverlay.classList.contains('show')) {
            hideOverlay(helpOverlay);
            e.preventDefault();
            return;
          }
          // –ò –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –≤—ã–∫–ª—é—á–∞–µ–º –ø–∏–ø–µ—Ç–∫—É
          setEyedropperActive(false);
        }
      });

  // –∑–∞–ø—É—Å–∫ –ª–æ–≥–∏–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü —Å–ø—Ä–∞–≤–∫–∏
      initHelpPaging();
    }


    startAll();
  })();


  </script>
</body>
</html>
