<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f4f4f5; --text: #0f172a; --muted: #64748b; --card: #fff; --stroke: #e5e7eb;
      --accent: #0f172a; --accent-ink: #fff; --good-bg: #ecfccb; --good-ink: #365314;
      --content-max: 1200px; --gap: 24px;
    }
    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }

    /* –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ */
    .site-header {
      position: relative;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: center;
      padding: 10px 18px 14px;
      background: #f8fafc;
      border-bottom: 1px solid var(--stroke);
      min-height: 65px;
    }
    .hslot {
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: inherit;
      font-weight: 600;
    }
    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1;
    }
    .brand .above {
      font-size: 30px;
      font-weight: 800;
      transform: translateY(-18%);
    }
    .brand .below {
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .04em;
      text-transform: uppercase;
      transform: translateY(18%);
    }

    .wrap {
      max-width: var(--content-max);
      margin: 22px auto;
      padding: 0 18px;
    }

    /* –†—è–¥ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥ —Ç–∞–π–º–µ—Ä–æ–º */
.top-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin: 12px 0 24px;  /* –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –æ—Ç —Ç–∞–π–º–µ—Ä–∞ –∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å–Ω–∏–∑—É –ø–µ—Ä–µ–¥ –∫–∞–¥—Ä–∞–º–∏ */
  flex-wrap: wrap;
}


    /* –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –ø–æ–¥ –≤–µ—Ä—Ö–Ω–∏–º —Ä—è–¥–æ–º */
        .series-title {
      font-size: 40px;     /* –∫–∞–∫ —É —Ç–∞–π–º–µ—Ä–∞ */
      font-weight: 800;    /* –ñ–ò–†–ù–´–ô */
      text-align: center;
      margin-bottom: 20px; /* –ë–û–õ–¨–®–ï –æ—Ç—Å—Ç—É–ø –≤–Ω–∏–∑ –¥–æ —Ç–∞–π–º–µ—Ä–∞ ‚Äî –ª–∏—à–Ω—è—è ¬´—Å—Ç—Ä–æ–∫–∞ –≤–æ–∑–¥—É—Ö–∞¬ª */
      display: block;
    }



    /* –ë–ª–æ–∫ —Ç–∞–π–º–µ—Ä–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞ */
    .timer-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  margin: 10px 0 8px;  /* –º–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø –≤–Ω–∏–∑, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –±—ã–ª–∏ –±–ª–∏–∂–µ –∫ —Ç–∞–π–º–µ—Ä—É */
  text-align: center;
}


        .vote-status {
      font-size: 18px;           /* –±—ã–ª–æ 14 */
      color: var(--muted);
      min-height: 22px;          /* —á—É—Ç—å –≤—ã—à–µ –ø–æ–¥ –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
    }


    .series-link {
      font-weight: 600;
      text-decoration: none;
      color: var(--accent);
    }
    .series-link.placeholder {
      color: var(--muted);
      pointer-events: none;
    }

    .timer {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 400;          /* —Å—Ç–∞–ª–æ –ù–ï–∂–∏—Ä–Ω—ã–º */
      font-size: 40px;           /* —Ä–∞–∑–º–µ—Ä —Ç–æ—Ç –∂–µ */
      line-height: 1;
      letter-spacing: 0.08em;
    }

    .frames {
      display: grid;
      grid-template-columns: repeat(4, minmax(240px, 1fr));
      gap: var(--gap);
    }

    @media (max-width: 1180px) {
      .frames {
        grid-template-columns: repeat(3, minmax(240px, 1fr));
      }
    }
    @media (max-width: 900px) {
      .frames {
        grid-template-columns: repeat(2, minmax(240px, 1fr));
      }
    }
    @media (max-width: 560px) {
      .frames {
        grid-template-columns: 1fr;
      }
    }

    .frame {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è */
    .frame--winner {
      border-color: hsl(46, 100%, 50%);
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.4);
    }

    .frame img {
      display: block;
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: contain;
      background: #f8fafc;
      border: 1px dashed #e2e8f0;
      border-radius: 10px;
      cursor: zoom-in;
    }

    .controls {
      display: grid;
      grid-template-columns: 48px 1fr 48px;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #f1f5f9;
    }

    .controls .score {
      justify-self: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      text-align: center;
      color: var(--text);
    }

    .controls .score .score-top {
      font-weight: 800;
    }

    .controls .score .score-sub {
      font-weight: 600;
      color: var(--muted);
      font-size: 12px;
    }

    .controls button {
      height: 36px;
      border: none;
      border-radius: 10px;
      background: var(--accent);
      color: var(--accent-ink);
      font-weight: 700;
      cursor: pointer;
    }

    .controls button[disabled] {
      opacity: .45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .winner {
      display: inline-block;
      margin-top: 10px;
      background: hsl(46, 100%, 50%);;
      color: var(--good-ink);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
    }

    .nav-bottom {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      margin: 20px 0 28px;
      flex-wrap: wrap;
    }

    .btn-outline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: #fff;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-outline:hover {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 800;
      text-decoration: none;
      cursor: pointer;
    }

    #finalize-inline {
      display: none;
    }

    .banner {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px dashed #cbd5e1;
      background: #fff;
      font-size: 14px;
    }

    .banner strong {
      font-weight: 800;
    }

    body.site-closed {
      overflow: hidden;
    }
    .site-closed-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(6px);
    }
    .site-closed-card {
      max-width: 420px;
      width: 100%;
      border-radius: 16px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 18px 18px 16px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.8);
      font-size: 14px;
    }
    .site-closed-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .site-closed-text {
      font-size: 14px;
      color: #cbd5f5;
    }

    .image-modal {
      position: fixed;
      inset: 0;
      z-index: 9998;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(15,23,42,0.78);
      backdrop-filter: blur(6px);
    }
    .image-modal-inner {
      position: relative;
      max-width: 96vw;
      max-height: 96vh;
      padding-bottom: 12vh;
    }
    .image-modal-img {
      display: block;
      max-width: 100%;
      max-height: 75vh;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.9);
      background: #020617;
      border: 1px solid rgba(148,163,184,0.7);
    }
    .image-modal-close {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 25px rgba(15,23,42,0.8);
    }
    .image-modal-close:hover {
      background: #ef4444;
      color: #f9fafb;
    }

    /* –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Äî –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ —Å—Ç–∏–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å */
    #result-screen {
      display: none;
    }

    #empty-message {
      margin-top: 20px;
      font-size: 14px;
      color: var(--muted);
      text-align: center;
    }
  </style>

  <!-- Supabase v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- –£—Ç–∏–ª–∏—Ç—ã –∞–¥–º–∏–Ω–∞ (isAdmin –∏ —Ç.–ø.) -->
  <script src="admin.js"></script>

  <script>
    // === –ì–ª—É—à–∏–º —à—É–º–Ω—É—é –æ—à–∏–±–∫—É LockManager ===
    window.addEventListener("unhandledrejection", (event) => {
      try {
        const msg = event?.reason?.message || String(event.reason || "");
        if (msg.includes("Navigator LockManager")) {
          console.warn("[kadry] LockManager suppressed (unhandledrejection):", msg);
          event.preventDefault();
        }
      } catch (_) {}
    });
    window.onerror = function (message) {
      try {
        const msg = String(message || "");
        if (msg.includes("Navigator LockManager")) {
          console.warn("[kadry] LockManager suppressed (onerror):", msg);
          return true;
        }
      } catch (_) {}
      return false;
    };

    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase ===
    const SUPABASE_URL = "https://upanhirmxhfzpajvswoq.supabase.co";
    const SUPABASE_ANON =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwYW5oaXJteGhmenBhanZzd29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjIwNzcsImV4cCI6MjA3MjIzODA3N30.HhrccU3DfoLadflBmTxIDXJgrDQB3m2zLRX3vtRycGA";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã URL ===
    const url = new URL(window.location.href);
    const seriesId = Number(url.searchParams.get("series")) || null;

    // === –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
    let currentSeries = null;
    let frames = [];
    let voteScores = {};   // frame_id -> { score, count }
    let voteState = "active";
    let voteRoundStart = null;
    let voteRoundEnd   = null;

    let timerIntervalId = null;
    let timerLastSyncAt = 0;
    let autoFinalized   = false;

    let isAdminForVoting = false;
    let adminUiBound     = false;

    // –≥–æ–ª–æ—Å–∞ –≥–æ—Å—Ç–µ–π –≤–Ω—É—Ç—Ä–∏ –≤–∫–ª–∞–¥–∫–∏ (–¥–æ–ø. –∑–∞—â–∏—Ç–∞ –∫ RLS)
    const votedFrames = new Set();

    // —É—Å—Ç–æ–π—á–∏–≤—ã–π anon_id –≤ localStorage
    let cachedAnonId = null;
    function getAnonId() {
      if (cachedAnonId) return cachedAnonId;
      try {
        const KEY = "kadry_anon_id_v1";
        const stored = window.localStorage.getItem(KEY);
        if (stored) {
          cachedAnonId = stored;
          return cachedAnonId;
        }
        let id;
        if (window.crypto?.randomUUID) {
          id = window.crypto.randomUUID();
        } else {
          id = Date.now().toString(36) + Math.random().toString(36).slice(2, 10);
        }
        window.localStorage.setItem(KEY, id);
        cachedAnonId = id;
        return cachedAnonId;
      } catch (e) {
        console.warn("[vote] anon_id error:", e);
        return null;
      }
    }

    // === –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ —Ç–∞–π–º–µ—Ä–æ–º ===
    function setVoteStatus(text) {
      const el = document.getElementById("vote-status");
      if (!el) return;
      el.textContent = text || "";
    }

    function baseStatusByState() {
      if (voteState === "winner_frozen") return "–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –æ–≤–∞—Ü–∏–∏!";
      if (voteState === "replay_frozen") return "–ú–æ–∂–µ—Ç –≤—Å—ë-—Ç–∞–∫–∏ –ø–µ—Ä–µ–∏–≥—Ä–∞–µ–º?";
      if (voteState === "active")        return "–î–∞ –±—É–¥–µ—Ç –∂–µ –∏–≥—Ä–∞!";
      return "";
    }

    // === –ú–æ–¥–∞–ª–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
    let imageModal, imageModalImg, imageModalClose;
    function initImageModal() {
      imageModal      = document.getElementById("image-modal");
      imageModalImg   = document.getElementById("image-modal-img");
      imageModalClose = document.getElementById("image-modal-close");

      if (imageModalClose) {
        imageModalClose.addEventListener("click", closeImageModal);
      }
      if (imageModal) {
        imageModal.addEventListener("click", (e) => {
          if (e.target === imageModal) closeImageModal();
        });
      }
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" || e.key === "Esc") closeImageModal();
      });
    }
    function openImageModal(src, alt) {
      if (!imageModal || !imageModalImg || !src) return;
      imageModalImg.src = src;
      imageModalImg.alt = alt || "–ö–∞–¥—Ä";
      imageModal.style.display = "flex";
      document.body.style.overflow = "hidden";
    }
    function closeImageModal() {
      if (!imageModal) return;
      imageModal.style.display = "none";
      document.body.style.overflow = "";
    }

    // === –ë–∞–Ω–Ω–µ—Ä "—Å–∞–π—Ç –∑–∞–∫—Ä—ã—Ç" ===
    async function checkSiteOpen() {
      console.log("[kadry][vote] checkSiteOpen()");
      let admin = false;
      if (typeof window.isAdmin === "function") {
        try { admin = await window.isAdmin(); } catch(e) {
          console.warn("[kadry][vote] isAdmin() failed:", e);
        }
      }

      try {
        const { data, error } = await supabaseClient
          .from("site_state")
          .select("is_open, announcement")
          .limit(1)
          .single();

        if (error || !data) return;

        const open = data.is_open !== false;
        if (!open && !admin) {
          const overlay = document.getElementById("site-closed-overlay");
          const msgEl   = document.getElementById("site-closed-message");
          if (msgEl) msgEl.textContent =
            data.announcement || "–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.";
          if (overlay) {
            overlay.style.display = "flex";
            document.body.classList.add("site-closed");
          }
        }
      } catch (e) {
        console.warn("[kadry][vote] checkSiteOpen error:", e);
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–∏–∏ ===
    function applySeriesRow(row) {
      if (!row) return;
      currentSeries  = row;
      voteState      = row.vote_state || "active";
      voteRoundStart = row.vote_round_start_at ? new Date(row.vote_round_start_at) : null;
      voteRoundEnd   = row.vote_round_end_at   ? new Date(row.vote_round_end_at)   : null;

      const titleLink = document.getElementById("seriesName");
      if (titleLink) {
        titleLink.textContent = row.title || `–°–µ—Ä–∏—è #${row.id}`;
        titleLink.href = `series.html?id=${row.id}`;
        titleLink.classList.remove("placeholder");
      }
      const backLink = document.getElementById("backToSeries");
      if (backLink) {
        backLink.href = `series.html?id=${row.id}`;
      }
            const addLink = document.getElementById("addFrame");
      if (addLink) {
        // –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä —É—á–∞—Å—Ç–∏—è —É —Ç–µ–±—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–∞—á–µ ‚Äî –∑–∞–º–µ–Ω–∏ draw.html –Ω–∞ –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª
        addLink.href = `editor.html?series=${row.id}`;
      }

    }

    async function loadSeries() {
      if (!seriesId) return;
      const { data, error } = await supabaseClient
        .from("series")
        .select("id, title, vote_state, vote_round_start_at, vote_round_end_at, vote_round_id")
        .eq("id", seriesId)
        .single();

      if (error) {
        console.error("[vote] loadSeries error:", error);
        return;
      }
      applySeriesRow(data);
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–¥—Ä–æ–≤ ===

// === –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–¥—Ä–æ–≤ ===
// –ù–∞ –ö–ê–ñ–î–û–ú —ç—Ç–∞–ø–µ (active / winner_frozen / replay_frozen)
// –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –∫–∞–¥—Ä—ã –ü–û–°–õ–ï–î–ù–ï–ì–û —Ä–∞—É–Ω–¥–∞.
// –†–∞—É–Ω–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É order_index –≤ —ç—Ç–æ–π —Å–µ—Ä–∏–∏.
async function loadFrames() {
  if (!seriesId) return;

  // 1. –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—É–Ω–¥–∞ –¥–ª—è —Å–µ—Ä–∏–∏
  const { data: idxRows, error: idxError } = await supabaseClient
    .from("frames")
    .select("order_index")
    .eq("series_id", seriesId)
    .not("order_index", "is", null)
    .order("order_index", { ascending: false })
    .limit(1);

  if (idxError) {
    console.error("[vote] loadFrames(order_index) error:", idxError);
    frames = [];
    return;
  }

  // –ï—Å–ª–∏ –≤ —Å–µ—Ä–∏–∏ –µ—â—ë –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä–∞—É–Ω–¥–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  if (!idxRows || idxRows.length === 0) {
    frames = [];
    return;
  }

  const lastOrderIndex = idxRows[0].order_index;

  // 2. –ë–µ—Ä—ë–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¢–û–õ–¨–ö–û —ç—Ç–æ–≥–æ —Ä–∞—É–Ω–¥–∞
  // (–ø–æ–±–µ–¥–∏—Ç–µ–ª—å, –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–µ, —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∏ ‚Äî —É –≤—Å–µ—Ö –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ order_index)
  const { data, error } = await supabaseClient
    .from("frames")
    .select("*")
    .eq("series_id", seriesId)
    .eq("order_index", lastOrderIndex)
    .order("id", { ascending: true });

  if (error) {
    console.error("[vote] loadFrames error:", error);
    frames = [];
    return;
  }

  frames = data || [];
}



    // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á—ë—Ç–æ–≤ ===
    function updateScoreTexts() {
      const container = document.getElementById("frames-container");
      if (!container) return;

      const cards = container.querySelectorAll(".frame");
      cards.forEach((card) => {
        const frameId = Number(card.dataset.id);
        const topEl = card.querySelector(".score-top");
        const subEl = card.querySelector(".score-sub");
        if (!topEl || !subEl) return;

                const s = voteScores[frameId];
        if (!s) {
          // –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤ –∏–ª–∏ –∫–∞—Ä—Ç–∞ –µ—â—ë –Ω–µ –ø–æ—Å—á–∏—Ç–∞–Ω–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 0
          topEl.textContent = "0";
          subEl.textContent = "–≥–æ–ª–æ—Å–æ–≤";
        } else {
          topEl.textContent = String(s.score);
          const c = s.count;
          let word = "–≥–æ–ª–æ—Å–æ–≤";
          if (c === 1) word = "–≥–æ–ª–æ—Å";
          else if (c >= 2 && c <= 4) word = "–≥–æ–ª–æ—Å–∞";
          subEl.textContent = word;
        }

      });
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
    async function loadUserVotes() {
      if (!currentSeries || !currentSeries.vote_round_id) return;

      const anonId = getAnonId();
      if (!anonId) return;

      const { data, error } = await supabaseClient
        .from("votes")
        .select("frame_id")
        .eq("round_id", currentSeries.vote_round_id)
        .eq("anon_id", anonId);

      if (error) {
        console.warn("[vote] loadUserVotes error:", error);
        return;
      }

      votedFrames.clear();
      (data || []).forEach(row => votedFrames.add(row.frame_id));
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤ ===
    async function loadScores() {
      if (!currentSeries || !currentSeries.vote_round_id) {
        voteScores = {};
        updateScoreTexts();
        return;
      }

      const { data, error } = await supabaseClient
        .from("votes")
        .select("frame_id, value, round_id")
        .eq("round_id", currentSeries.vote_round_id);

      if (error) {
        console.error("[vote] loadScores error:", error);
        return;
      }

      const map = {};
      (data || []).forEach((row) => {
        const fid = row.frame_id;
        if (!map[fid]) map[fid] = { score: 0, count: 0 };
        map[fid].score += row.value || 0;
        map[fid].count += 1;
      });

      voteScores = map;
      updateScoreTexts();
    }

    // === –†–µ–Ω–¥–µ—Ä –∫–∞–¥—Ä–æ–≤ ===
    function renderFrames() {
      const container = document.getElementById("frames-container");
      if (!container) return;
      container.innerHTML = "";

      frames.forEach((frame) => {
        const div = document.createElement("div");
        div.className = "frame";
        div.dataset.id = frame.id;

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        if (voteState === "winner_frozen" && frame.committed) {
          div.classList.add("frame--winner");
        }

        const img = document.createElement("img");
        const url = frame.image_url || frame.url || "";
        img.src = url || "";
        img.alt = "–ö–∞–¥—Ä #" + frame.id;
        img.addEventListener("click", () => {
          if (url) openImageModal(url, img.alt);
        });
        div.appendChild(img);

        const controls = document.createElement("div");
        controls.className = "controls";

        const minus = document.createElement("button");
        minus.type = "button";
        minus.textContent = "‚àí1";
        minus.className = "vote-btn";
        minus.dataset.id = frame.id;
        minus.dataset.v = -1;

        const plus = document.createElement("button");
        plus.type = "button";
        plus.textContent = "+1";
        plus.className = "vote-btn";
        plus.dataset.id = frame.id;
        plus.dataset.v = 1;

         const scoreWrap = document.createElement("div");
        scoreWrap.className = "score";
        const top = document.createElement("div");
        top.className = "score-top";
        top.textContent = "0";          // –±—ã–ª–æ "‚Äî"
        const sub = document.createElement("div");
        sub.className = "score-sub";
        sub.textContent = "–≥–æ–ª–æ—Å–æ–≤";
        scoreWrap.appendChild(top);
        scoreWrap.appendChild(sub);

        controls.appendChild(minus);
        controls.appendChild(scoreWrap);
        controls.appendChild(plus);

        div.appendChild(controls);

        // –ø–æ–¥–ø–∏—Å—å ¬´–ü–æ–±–µ–¥–∏—Ç–µ–ª—å¬ª –ø–æ–¥ –∫–∞–¥—Ä–æ–º
        if (voteState === "winner_frozen" && frame.committed) {
          const badge = document.createElement("div");
          badge.className = "winner";
          badge.textContent = "–ü–æ–±–µ–¥–∏—Ç–µ–ª—å";
          div.appendChild(badge);
        }

        container.appendChild(div);
      });
    }

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è ===
    function attachVoteButtons() {
      const buttons = document.querySelectorAll(".vote-btn");
      const anonId = getAnonId();

      buttons.forEach((btn) => {
        const frameId = Number(btn.dataset.id);
    // üîí –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ –∑–∞–º–æ—Ä–æ–∂–µ–Ω (–ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞), –í–°–ï –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
    if (voteState === "replay_frozen" || voteState === "winner_frozen") {
      btn.disabled = true;
      return; // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω—É–∂–µ–Ω
    }

        // üîí –ï—Å–ª–∏ –≥–æ—Å—Ç—å —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ —ç—Ç–æ—Ç –∫–∞–¥—Ä ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        // –ï—Å–ª–∏ –∞–¥–º–∏–Ω ‚Äî –í–°–ï–ì–î–ê —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
        if (isAdminForVoting) {
          btn.disabled = false;
        } else if (votedFrames.has(frameId)) {
          btn.disabled = true;
        }

        btn.onclick = async () => {
          const val = Number(btn.dataset.v);

          if (!currentSeries) return;

          if (voteState !== "active") {
            console.warn("[vote] –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ");
            return;
          }

          // –ê–¥–º–∏–Ω ‚Äî –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
          if (isAdminForVoting) {
            btn.disabled = false;
          } else if (votedFrames.has(frameId)) {
            btn.disabled = true;
            return;
          }

          // –§–æ—Ä–º–∏—Ä—É–µ–º payload
          const payload = {
            frame_id: frameId,
            value: val
          };

          if (!isAdminForVoting && anonId) {
            payload.anon_id = anonId;
          }

          if (currentSeries.vote_round_id) {
            payload.round_id = currentSeries.vote_round_id;
          }

          console.log("VOTE DEBUG:", {
            frame_id: frameId,
            round_id: currentSeries?.vote_round_id,
            anon_id: anonId,
            value: val,
            payload
          });

          btn.disabled = true;

          try {
            const { error } = await supabaseClient.from("votes").insert(payload);

            if (error) {
              console.error("[vote] insert vote error:", error);
            } else {
              // –ì–æ—Å—Ç—å ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
              if (!isAdminForVoting) {
                votedFrames.add(frameId);
                const card = btn.closest(".frame");
                if (card) {
                  card.querySelectorAll(".vote-btn").forEach((b) => (b.disabled = true));
                }
              }

              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—á—ë—Ç
              await loadScores();
            }

          } catch (e) {
            console.error("[vote] vote failed:", e);

          } finally {
            // –ê–¥–º–∏–Ω ‚Äî –∫–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
            if (isAdminForVoting) {
              btn.disabled = false;
            }
          }
        };
      });
    }

        // === –ü—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
    function updateEmptyMessage() {
      let msg = document.getElementById("empty-message");
      if (!msg) {
        msg = document.createElement("div");
        msg.id = "empty-message";
        const app = document.getElementById("app");
        if (app) app.appendChild(msg);
      }

      // 1) –°–æ–≤—Å–µ–º –Ω–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, —Ä–∞—É–Ω–¥ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω
      if (!currentSeries || !currentSeries.vote_round_id) {
        msg.textContent = "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä.";
        msg.style.display = "block";
        return;
      }

      // 2) –û–±—ã—á–Ω–æ–µ –ø—É—Å—Ç–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
      if (frames.length === 0 && voteState === "active") {
        msg.textContent =
          "–°–µ–π—á–∞—Å –Ω–µ—Ç –∫–∞–¥—Ä–æ–≤ –≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏. –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ —Ö—É–¥–æ–∂–Ω–∏–∫–∏ –¥–æ–±–∞–≤—è—Ç –∫–∞–¥—Ä—ã.";
        msg.style.display = "block";
      }
      // 3) –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞
      else if (voteState === "replay_frozen") {
        msg.textContent =
          "–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è. –ñ–¥—ë–º –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∏ —Å –Ω–æ–≤—ã–º–∏ –∫–∞–¥—Ä–∞–º–∏.";
        msg.style.display = "block";
      }
      // 4) –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –ø—Ä—è—á–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      else {
        msg.style.display = "none";
      }
    }


    // === –¢–∞–π–º–µ—Ä ===
    function formatTimer(ms) {
      if (ms == null) return "‚Äî:‚Äî";
      if (ms < 0) ms = 0;
      const totalSeconds = Math.floor(ms / 1000);
      const mm = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
      const ss = String(totalSeconds % 60).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    // —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å–µ—Ä–∏—é –∏–∑ –±–∞–∑—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
    async function syncSeriesForTimer() {
      if (!seriesId) return;

      // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —É –Ω–∞—Å –±—ã–ª–æ –î–û –∑–∞–ø—Ä–æ—Å–∞
      const prevState = voteState;

      try {
        const { data, error } = await supabaseClient
          .from("series")
          .select("id, title, vote_state, vote_round_start_at, vote_round_end_at, vote_round_id")
          .eq("id", seriesId)
          .single();

        if (error || !data) {
          console.warn("[vote] timer sync error:", error || "no data");
          return;
        }

        // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Ä–∏—é –∏ voteState/voteRoundEnd
        applySeriesRow(data);
        timerLastSyncAt = Date.now();

        // –µ—Å–ª–∏ —Ä–∞—É–Ω–¥ –±—ã–ª active, –∞ —Å—Ç–∞–ª –Ω–µ active ‚Äî —Å–µ—Ä–≤–µ—Ä —É–∂–µ –≤—Å—ë –ø–æ—Å—á–∏—Ç–∞–ª
        if (prevState === "active" && voteState !== "active") {
          console.log("[vote] round finished on server, reloadAll()");
          await reloadAll();    // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–¥—Ä—ã, —Å—Ç–∞—Ç—É—Å –∏ —Ç.–¥.
        }
      } catch (e) {
        console.warn("[vote] timer sync failed:", e);
      }
    }

    function startTimerLoop() {
      const timerEl = document.getElementById("timer");
      if (!timerEl || !seriesId) return;

      // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
      if (timerIntervalId != null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
      timerLastSyncAt = 0;

      const tick = async () => {
        // —Ä–∞–∑ –≤ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ–¥–Ω–∏–º–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—É–Ω–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        if (!timerLastSyncAt || Date.now() - timerLastSyncAt > 3000) {
          await syncSeriesForTimer();
        }

        // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –µ—â—ë –Ω–µ –≤—ã–¥–∞–ª –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ¬´‚Äî:‚Äî¬ª
        if (!voteRoundEnd) {
          timerEl.textContent = "‚Äî:‚Äî";
          setVoteStatus(baseStatusByState());
          return;
        }

        // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –ø–µ—Ä–µ–≤—ë–ª —Ä–∞—É–Ω–¥ –∏–∑ active –≤ –¥—Ä—É–≥–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî
        // –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 00:00 –∏ —Å—Ç–∞—Ç—É—Å –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
        if (voteState !== "active") {
          timerEl.textContent = "00:00";
          setVoteStatus(baseStatusByState());
          return;
        }

        const remaining = voteRoundEnd.getTime() - Date.now();

        // –≤—Ä–µ–º—è –≤—ã—à–ª–æ, –Ω–æ —Ä–µ—à–µ–Ω–∏–µ –µ—â—ë –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        if (remaining <= 0) {
          timerEl.textContent = "00:00";
          setVoteStatus("–ü–æ–¥–≤–æ–¥–∏–º –∏—Ç–æ–≥–∏‚Ä¶");
          return;
        }

        // –æ–±—ã—á–Ω—ã–π —Ö–æ–¥ —Ç–∞–π–º–µ—Ä–∞
        timerEl.textContent = formatTimer(remaining);
        setVoteStatus(baseStatusByState());
      };

      // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
      tick();
      timerIntervalId = setInterval(tick, 1000);
    }

    // === –ê–¥–º–∏–Ω—Å–∫–∏–π —Ç–∞–π–º–µ—Ä –∏ –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥" ===
    async function detectAdmin() {
      let admin = false;
      if (typeof window.isAdmin === "function") {
        try { admin = await window.isAdmin(); } catch (e) {
          console.warn("[kadry][vote] isAdmin() failed:", e);
        }
      }
      isAdminForVoting = admin;
      return admin;
    }

    async function adminSetRemaining(ms) {
      if (!seriesId) return;
      console.log("[vote][adminSetRemaining] ms =", ms, "seriesId =", seriesId);
      try {
        const { data, error } = await supabaseClient.rpc(
          "voting_admin_set_remaining",
          { p_series_id: seriesId, p_ms: ms }
        );
        if (error) {
          console.error("[vote] adminSetRemaining rpc error:", error);
          return;
        }

        const row = Array.isArray(data) ? data[0] : data;
        if (!row) {
          console.warn("[vote] adminSetRemaining: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");
          return;
        }

        console.log("[vote][adminSetRemaining] RPC OK:", row);
        applySeriesRow(row);
        autoFinalized = false;
        startTimerLoop();
        broadcastRoundUpdated();
      } catch (e) {
        console.error("[vote] adminSetRemaining failed:", e);
      }
    }

    async function finalizeRoundManually() {
      if (!seriesId) return;
      try {
        const { error } = await supabaseClient.rpc("voting_finalize_round", {
          p_series_id: seriesId,
        });
        if (error) {
          console.error("[vote] finalize (manual) error:", error);
          return;
        }
      } catch (e) {
        console.error("[vote] finalize (manual) failed:", e);
      }
      await reloadAll();
      broadcastRoundUpdated();
    }

    async function refreshAdminUi() {
      const admin = await detectAdmin();

      const finalizeBtn = document.getElementById("finalize-inline");
      const btn10 = document.getElementById("admin-timer-10s");
      const btn15 = document.getElementById("admin-timer-15m");

      // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏
      if (finalizeBtn) finalizeBtn.style.display = admin ? "inline-flex" : "none";
      if (btn10)       btn10.style.display       = admin ? "inline-flex" : "none";
      if (btn15)       btn15.style.display       = admin ? "inline-flex" : "none";

      // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
      if (!refreshAdminUi.bound) {
        refreshAdminUi.bound = true;

        if (finalizeBtn) {
          finalizeBtn.addEventListener("click", () => {
            console.log("[admin] finalize");
            finalizeRoundManually();
          });
        }

        if (btn10) {
          btn10.addEventListener("click", () => {
            console.log("[admin] set 10s");
            adminSetRemaining(10 * 1000);
          });
        }

        if (btn15) {
          btn15.addEventListener("click", () => {
            console.log("[admin] set 15m");
            adminSetRemaining(15 * 60 * 1000);
          });
        }
      }

      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å UI —Å —É—á—ë—Ç–æ–º —Ä–æ–ª–∏
      await loadUserVotes();
      renderFrames();
      attachVoteButtons();
      await loadScores();
    }

    // === BroadcastChannel –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–æ–∫ ===
    let bc = null;

    function initBroadcastChannel() {
      if (!("BroadcastChannel" in window)) return;
      if (bc) return; // —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

      bc = new BroadcastChannel("kadry-vote");

      bc.onmessage = async (event) => {
        const data = event?.data;
        if (!data) return;

        // –î—Ä—É–≥–æ–π —Ç–∞–± —Å–æ–æ–±—â–∏–ª, —á—Ç–æ —Ä–∞—É–Ω–¥ –æ–±–Ω–æ–≤–∏–ª—Å—è
        if (data.type === "round_updated" && data.seriesId === seriesId) {
          console.log("[vote] broadcast: round_updated, reloadAll()");
          await reloadAll();
        }
      };
    }

    function broadcastRoundUpdated() {
      if (!bc || !seriesId) return;
      try {
        bc.postMessage({ type: "round_updated", seriesId });
      } catch (e) {
        console.warn("[vote] broadcast failed:", e);
      }
    }

    // === Supabase Realtime: –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–∏–∏ ===
    let seriesRealtimeChannel = null;

    function initSeriesRealtime() {
      if (!seriesId) return;
      if (!supabaseClient || typeof supabaseClient.channel !== "function") return;
      if (seriesRealtimeChannel) return; // —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å

      seriesRealtimeChannel = supabaseClient
        .channel("series-vote-" + seriesId)
        .on(
          "postgres_changes",
          {
            event: "UPDATE",
            schema: "public",
            table: "series",
            filter: `id=eq.${seriesId}`,
          },
          async (payload) => {
            const oldState = payload?.old?.vote_state;
            const newState = payload?.new?.vote_state;

            if (oldState !== newState) {
              console.log(
                "[vote] realtime series status changed:",
                oldState,
                "‚Üí",
                newState
              );
              await reloadAll(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–¥—Ä—ã/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/–∫–Ω–æ–ø–∫–∏
            }
          }
        )
        .subscribe((status) => {
          console.log("[vote] realtime subscribe status =", status);
        });
    }

       async function reloadAll() {
      await loadSeries();
      await loadFrames();      // 1 ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–¥—Ä—ã

      // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω (vote_round_id = NULL),
      // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–¥—Ä –≤ —Å–µ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
      if (!currentSeries || !currentSeries.vote_round_id) {
        frames = [];
      }

      renderFrames();          // 2 ‚Äî —Ä–∏—Å—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
      await loadUserVotes();   // 3 ‚Äî —É–∑–Ω–∞—ë–º, –∫–∞–∫–∏–µ –∫–∞–¥—Ä—ã –≥–æ—Å—Ç—å —É–∂–µ –æ—Ü–µ–Ω–∏–ª

      attachVoteButtons();     // 4 ‚Äî —Å–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ (–∏ –±–ª–æ–∫–∏—Ä—É–µ–º –≥–æ—Å—Ç—é)

      await loadScores();      // 5 ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—ã –≥–æ–ª–æ—Å–æ–≤

      startTimerLoop();
      updateEmptyMessage();
    }

    // === –°—Ç–∞—Ä—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
    document.addEventListener("DOMContentLoaded", async () => {
      initImageModal();
      await checkSiteOpen();

      // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–Ω–∞–ª—ã
      initBroadcastChannel();
      initSeriesRealtime();

      // –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
      await reloadAll();
      await refreshAdminUi();

      window.addEventListener("admin:enabled", async () => {
        await refreshAdminUi();
      });
      window.addEventListener("admin:disabled", async () => {
        await refreshAdminUi();
      });
    });
  </script>
</head>
<body>

  <div id="site-closed-overlay" class="site-closed-overlay" style="display:none">
    <div class="site-closed-card">
      <div class="site-closed-title">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç</div>
      <div class="site-closed-text" id="site-closed-message">
        –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ.
      </div>
    </div>
  </div>

  <div id="image-modal" class="image-modal" style="display:none">
    <div class="image-modal-inner">
      <button type="button" id="image-modal-close" class="image-modal-close">√ó</button>
      <img id="image-modal-img" class="image-modal-img" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–¥—Ä–∞">
    </div>
  </div>

  <header class="site-header">
    <div class="hslot h1">
      <div class="brand">
        <div class="above">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</div>
        <div class="below">Kadry</div>
      </div>
    </div>
    <a class="hslot h2" href="index.html">–ö–∞—Ç–∞–ª–æ–≥</a>
    <a class="hslot h3" href="votes.html">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</a>
    <a class="hslot h4" href="#">–ü—Ä–æ—Ñ–∏–ª—å</a>
  </header>

    <div class="wrap" id="app">
    <!-- –°–ù–ê–ß–ê–õ–ê –ù–ê–ó–í–ê–ù–ò–ï –°–ï–†–ò–ò -->
    <a id="seriesName"
       class="series-link placeholder series-title"
       href="#">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏</a>

    <!-- –ü–û–¢–û–ú –¢–ê–ô–ú–ï–† –°–û –°–¢–ê–¢–£–°–û–ú -->
    <div class="timer-block">
      <div class="timer"><span id="timer">‚Äî:‚Äî</span></div>
      <div id="vote-status" class="vote-status"></div>
    </div>

    <!-- –°–†–ê–ó–£ –ü–û–î –¢–ê–ô–ú–ï–†–û–ú ‚Äî –†–Ø–î –° –ö–ù–û–ü–ö–ê–ú–ò -->
    <div class="top-row">
      <a id="backToSeries" class="btn-outline" href="#">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Å–µ—Ä–∏—é</a>
      <a id="addFrame" class="btn-outline" href="#">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–¥—Ä</a>
    </div>

    <!-- –°–ï–¢–ö–ê –ö–ê–î–†–û–í -->
    <div id="frames-container" class="frames"></div>

    <!-- result-screen –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è -->
    <section id="result-screen"></section>

    <!-- –ê–î–ú–ò–ù–°–ö–ò–ï –ö–ù–û–ü–ö–ò –í–ù–ò–ó–£ -->
    <div class="nav-bottom">
      <button id="finalize-inline" class="btn-primary" type="button">–ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥</button>
      <button id="admin-timer-10s" class="btn-primary" type="button" style="display:none;">‚è± 00:10</button>
      <button id="admin-timer-15m" class="btn-primary" type="button" style="display:none;">‚è± 15:00</button>
    </div>

    <!-- –ü–†–ê–í–ò–õ–ê –†–ê–£–ù–î–ê -->
    <div class="banner" style="margin-top:20px">
      <div><strong>–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞—É–Ω–¥–∞</strong></div>
      <ul>
        <li><b>–¢–µ—Ä–º–∏–Ω—ã.</b> <i>–°—á—ë—Ç</i> ‚Äî —Å—É–º–º–∞ –≥–æ–ª–æ—Å–æ–≤ (+1/‚àí1). <i>–ì–æ–ª–æ—Å–∞</i> ‚Äî —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ –∫–∞–¥—Ä—É –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏.</li>
        <li><b>–ö—Ç–æ —É—á–∞—Å—Ç–≤—É–µ—Ç.</b> –£—á–∞—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –∫–∞–¥—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞. –ï—Å–ª–∏ —É –≤—Å–µ—Ö <code>–≥–æ–ª–æ—Å–∞ = 0</code> ‚Äî –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞.</li>
        <li><b>–ü–æ—Ä–æ–≥ —É—á–∞—Å—Ç–∏—è (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π).</b> –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî <b>2 –≥–æ–ª–æ—Å–∞</b>. –ï—Å–ª–∏ —Å—É–º–º–∞—Ä–Ω–æ –ø–æ —Ä–∞—É–Ω–¥—É <b>‚â§ 3</b>, –ø–æ—Ä–æ–≥ ‚Äî <b>1</b>.</li>
        <li><b>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å.</b> –°–Ω–∞—á–∞–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—á—ë—Ç, –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ ‚Äî –±–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤; –ø–æ–ª–Ω–∞—è –Ω–∏—á—å—è ‚Äî –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞.</li>
        <li><b>–ù—É–ª–µ–≤–æ–π —Å—á—ë—Ç.</b> –ö–∞–¥—Ä —Å–æ —Å—á—ë—Ç–æ–º <code>0</code> –º–æ–∂–µ—Ç –ø–æ–±–µ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ —É—á–∞—Å—Ç–∏—è.</li>
        <li><b>–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –º–∞–∫—Å–∏–º—É–º.</b> –ï—Å–ª–∏ –ª—É—á—à–∏–π —Å—á—ë—Ç &lt; 0 ‚Äî –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞.</li>
        <li><b>–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫.</b> –ï—Å–ª–∏ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –∫–∞–¥—Ä —Å –≥–æ–ª–æ—Å–∞–º–∏ –∏ –µ–≥–æ —Å—á—ë—Ç ‚â• 1 ‚Äî –æ–Ω –ø–æ–±–µ–∂–¥–∞–µ—Ç.</li>
      </ul>
    </div>
  </div>

</body>
</html>
